# Calculations: advanced workflow {#calcs-advanced}

The purpose of Chapter \@ref(calcs-advanced) is to build off the basic workflow for calculating OHI scores and do a few more advanced things. This is a a 2-hour hands-on training: you will be following along on your own computer and working with a copy of the demonstration repository that is used throughout the this chapter.

## Overview

TODO: Recurring theme here: what goals are included in my assessment? 

Worth noting too that we'll be improving goals.csv operates because there are some inefficiencies/things that are a bit error prone...

Good practice to run `calculate_scores.r` and use Git window to check your work. 

TODO: add commits, sync to this

### Prerequisites

Before the training, please make sure you have done the following: 

1. Have up-to-date versions of `R` and RStudio and have RStudio configured with Git/GitHub <!--- TODO (Chapter \@ref(datascience))--->
    - https://cloud.r-project.org
    - http://www.rstudio.com/download 
    - http://happygitwithr.com/rstudio-git-github.html 
1. Fork the **toolbox-demo** repository into your own GitHub account by going to https://github.com/OHI-Science/toolbox-demo, clicking "Fork" in the upper right corner, and selecting your account
1. Clone the **toolbox-demo** repo from your GitHub account into RStudio into a folder called "github" in your home directory (filepath "~/github")
1. Get comfortable: be set up with two screens if possible. You will be following along in RStudio on your own computer while also watching an instructor's screen or following this tutorial.

Additionally, this chapter assumes you are familiar with content from Chapter \@ref(calcs-basic), so review that first if needed. 

----

## Explore goals.csv

This is the registry for goals. `ohicore` will use this list and make sure there are functions with the same names in `functions.r`. This is one of the things that does on in `Conf()`...

Let's open and inspect it 

- in excel
- focus on a few columns (see ecosystem for more)
- note "goal" and "parent"


This is where it happens:
```{r Conf, eval=FALSE}
conf = ohicore::Conf('conf')
```

<!--- TODO ohicore: Conf() should check that all entries in goals.csv are present in functions.r, but it doesn't. 
--->

## Round 1: Poke at it to see how it works

The Toolbox won't always give errors when you start changing things (work in progress), so let's just see what some of these things look like. This is when using the Git tab to help you keep track of how things work REALLY helps.

We'll try it from registry -> functions.r
and then from functions.r -> registry (goals.csv)


### Delete a goal cell in goals.csv

Eg delete "LSP"

run `calculate_scores.r`
what changed?

![](https://docs.google.com/drawings/d/19e7TVvpjUql46afZ38fXfkeKQ5sIkxXSnRIbJjxBzkk/pub?w=960&h=528)


### Remove a goal (whole row) in goals.csv

Here we see "Index" scores change, "SP" scores change, and "LSP" scores get deleted.

TODO: for both a goal and subgoal


## Round 2: Break it to see how it works

### Change `preindex_function` goals.csv

it's the preindex_function column that is critical for the functions. 
Let's add a typo there. 

```{r, eval=FALSE}
# Calculating Status and Trend for each region for HAB...
# Error in eval(expr, envir, enclos) : could not find function "HA"
```


### Add a new goal in goals.csv

Just copy-paste. 

What do you think will happen? what's the most important column? That's right, `preindex_function`.

![](https://docs.google.com/drawings/d/1yHSVfXvNu5hSTEa12uSD7mGQAUNDBSsgkaKYj01nEYc/pub?w=960&h=192)

This will fail at the scores calculation. 

```{r, eval=FALSE}
scores = ohicore::CalculateAll(conf, layers)
# Running Setup()...
# Calculating Status and Trend for each region for FIS...
# ...
# ...
# Calculating Status and Trend for each region for SPP...
# Calculating Status and Trend for each region for EX...
# Error in eval(expr, envir, enclos) : could not find function "EX"
write.csv(scores, 'scores.csv', na='', row.names=F)
# Error in is.data.frame(x) : object 'scores' not found
```

### Delete a goal model from `functions.r`

won't fail at Conf, but will at scores calc.
```{r, eval=FALSE}
# Calculating Status and Trend for each region for AO...
# Error in eval(expr, envir, enclos) : could not find function "AO"
# ...
write.csv(scores, 'scores.csv', na='', row.names=F)
# Error in is.data.frame(x) : object 'scores' not found
```

## Adding a new goal

this is how to do it right. Need to add the row in goals.csv and the function in functions.r

## Adding subgoals

## Modifying subgoals
TODO: how is this different than above?



## Chapter recap

- goals.csv, adding goals, removing, changing subgoals. trend years. 

## Changing subgoals 

### Update goal call in `goals.csv`

<!---TODISCUSS: maybe this detail should go somewhere else and then just referenced here? Because will also need this information referenced in the ## Removing Goals and ## Changing Subgoals sections --->

<!--- NOTE: this is where we'll talk about adding/removing goals/subgoals, and goals.csv. First will talk to Mel about goals.csv's future: maybe having them just written in functions.r, and have ohicore pull from that to make a full list --->

<!---
`goals.csv` in the `conf` folder provides input information for `functions.r`, particularly about function calls. These are indicated by two columns: *preindex_function* (functions for all goals that do not have sub-goals, and functions for all sub-goals) and *postindex_function* (functions for goals with sub-goals).

In the `preindex_fuction`, you could specify variables such as _status_year_ and _trend_year_, which you can call in your goal function. Note that it is not necessary to specify those variables. If you do not use them in your function as in the CS example, you could delete those variables in `preindex_function`.


_Changing goal weights will be done here by editing the value in the *weight* column. Weights do not need to be 0-1 or add up to 10; weights will be scaled as a proportion of the number of goals assessed. The ten goals are weighted equally by default._


![](https://docs.google.com/drawings/d/17BgYSw2sHbZvHNjUqBlTG-kCOAAn7o6a65O37s0S_es/pub?h=500)

![](https://docs.google.com/drawings/d/1o2wtJ9KCPDyGPH9Y4unmALG6BlxX9lmJ_PakDDiQrLo/pub?h=500)


--->

