<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Ocean Health Index Toolbox Training</title>
  <meta name="description" content="This is the official Ocean Health Index Toolbox training.">
  <meta name="generator" content="bookdown 0.3.9 and GitBook 2.6.7">

  <meta property="og:title" content="Ocean Health Index Toolbox Training" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is the official Ocean Health Index Toolbox training." />
  <meta name="github-repo" content="ohi-science/ohi-trainings" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Ocean Health Index Toolbox Training" />
  
  <meta name="twitter:description" content="This is the official Ocean Health Index Toolbox training." />
  

<meta name="author" content="Ocean Health Index Team">


<meta name="date" content="2017-02-23">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="prep-data.html">
<link rel="next" href="calcs-advanced.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Overview</a></li>
<li class="chapter" data-level="2" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>2</b> Introduction</a><ul>
<li class="chapter" data-level="2.1" data-path="index.html"><a href="index.html#overview"><i class="fa fa-check"></i><b>2.1</b> Overview</a></li>
<li class="chapter" data-level="2.2" data-path="intro.html"><a href="intro.html#ohi-conceptually"><i class="fa fa-check"></i><b>2.2</b> OHI conceptually</a></li>
<li class="chapter" data-level="2.3" data-path="intro.html"><a href="intro.html#best-practices"><i class="fa fa-check"></i><b>2.3</b> Best practices</a></li>
<li class="chapter" data-level="2.4" data-path="intro.html"><a href="intro.html#your-website"><i class="fa fa-check"></i><b>2.4</b> Your website</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="datascience.html"><a href="datascience.html"><i class="fa fa-check"></i><b>3</b> Data science workflow</a><ul>
<li class="chapter" data-level="3.1" data-path="datascience.html"><a href="datascience.html#ohi-repo"><i class="fa fa-check"></i><b>3.1</b> OHI+ Repo</a></li>
<li class="chapter" data-level="3.2" data-path="datascience.html"><a href="datascience.html#rstudio-github-workflow"><i class="fa fa-check"></i><b>3.2</b> RStudio-GitHub workflow</a></li>
<li class="chapter" data-level="3.3" data-path="datascience.html"><a href="datascience.html#how-you-work"><i class="fa fa-check"></i><b>3.3</b> How you work</a></li>
<li class="chapter" data-level="3.4" data-path="datascience.html"><a href="datascience.html#develop-skills"><i class="fa fa-check"></i><b>3.4</b> Developing these skills</a></li>
<li class="chapter" data-level="3.5" data-path="datascience.html"><a href="datascience.html#practice-by-updating-your-website"><i class="fa fa-check"></i><b>3.5</b> Practice by updating your website</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="toolbox.html"><a href="toolbox.html"><i class="fa fa-check"></i><b>4</b> Toolbox Ecosystem</a><ul>
<li class="chapter" data-level="4.1" data-path="toolbox.html"><a href="toolbox.html#overview-1"><i class="fa fa-check"></i><b>4.1</b> Overview</a></li>
<li class="chapter" data-level="4.2" data-path="toolbox.html"><a href="toolbox.html#prep-repo-files-and-organization"><i class="fa fa-check"></i><b>4.2</b> Prep repo files and organization</a></li>
<li class="chapter" data-level="4.3" data-path="toolbox.html"><a href="toolbox.html#full-repo-files-and-organization"><i class="fa fa-check"></i><b>4.3</b> Full repo files and organization</a><ul>
<li class="chapter" data-level="4.3.1" data-path="toolbox.html"><a href="toolbox.html#functions.r"><i class="fa fa-check"></i><b>4.3.1</b> functions.r</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="toolbox.html"><a href="toolbox.html#ohicore"><i class="fa fa-check"></i><b>4.4</b> <code>ohicore</code></a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="prep-data.html"><a href="prep-data.html"><i class="fa fa-check"></i><b>5</b> Preparing data</a><ul>
<li class="chapter" data-level="5.1" data-path="prep-data.html"><a href="prep-data.html#overview-2"><i class="fa fa-check"></i><b>5.1</b> Overview</a></li>
<li class="chapter" data-level="5.2" data-path="prep-data.html"><a href="prep-data.html#data-layer-formatting"><i class="fa fa-check"></i><b>5.2</b> Data layer formatting</a></li>
<li class="chapter" data-level="5.3" data-path="prep-data.html"><a href="prep-data.html#data-wrangling"><i class="fa fa-check"></i><b>5.3</b> Data wrangling</a></li>
<li class="chapter" data-level="5.4" data-path="prep-data.html"><a href="prep-data.html#save-and-register-data-layer"><i class="fa fa-check"></i><b>5.4</b> Save and register data layer</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="calcs-basic.html"><a href="calcs-basic.html"><i class="fa fa-check"></i><b>6</b> Calculations: basic workflow</a><ul>
<li class="chapter" data-level="6.1" data-path="calcs-basic.html"><a href="calcs-basic.html#overview-3"><i class="fa fa-check"></i><b>6.1</b> Overview</a><ul>
<li class="chapter" data-level="6.1.1" data-path="calcs-basic.html"><a href="calcs-basic.html#prerequisites"><i class="fa fa-check"></i><b>6.1.1</b> Prerequisites</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="calcs-basic.html"><a href="calcs-basic.html#review-the-toolbox-file-ecosystem"><i class="fa fa-check"></i><b>6.2</b> Review the Toolbox file ecosystem</a><ul>
<li class="chapter" data-level="6.2.1" data-path="calcs-basic.html"><a href="calcs-basic.html#run-install_ohicore.r"><i class="fa fa-check"></i><b>6.2.1</b> Run <code>install_ohicore.r</code></a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="calcs-basic.html"><a href="calcs-basic.html#run-calculate_scores.r"><i class="fa fa-check"></i><b>6.3</b> Run <code>calculate_scores.r</code></a><ul>
<li class="chapter" data-level="6.3.1" data-path="calcs-basic.html"><a href="calcs-basic.html#source-configure_toolbox.r"><i class="fa fa-check"></i><b>6.3.1</b> Source <code>configure_toolbox.R</code></a></li>
<li class="chapter" data-level="6.3.2" data-path="calcs-basic.html"><a href="calcs-basic.html#run-calculateall"><i class="fa fa-check"></i><b>6.3.2</b> Run <code>CalculateAll()</code></a></li>
<li class="chapter" data-level="6.3.3" data-path="calcs-basic.html"><a href="calcs-basic.html#save-scores-variable-as-scores.csv"><i class="fa fa-check"></i><b>6.3.3</b> Save scores variable as <code>scores.csv</code></a></li>
<li class="chapter" data-level="6.3.4" data-path="calcs-basic.html"><a href="calcs-basic.html#recap-of-what-just-happened"><i class="fa fa-check"></i><b>6.3.4</b> Recap of what just happened</a></li>
<li class="chapter" data-level="6.3.5" data-path="calcs-basic.html"><a href="calcs-basic.html#a-note-about-error-messages"><i class="fa fa-check"></i><b>6.3.5</b> A note about error messages</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="calcs-basic.html"><a href="calcs-basic.html#tailor-a-data-layer-and-rerun-calculate_scores.r"><i class="fa fa-check"></i><b>6.4</b> Tailor a data layer and rerun <code>calculate_scores.r</code></a><ul>
<li class="chapter" data-level="6.4.1" data-path="calcs-basic.html"><a href="calcs-basic.html#save-and-register-prepared-data-layer"><i class="fa fa-check"></i><b>6.4.1</b> Save and register prepared data layer</a></li>
<li class="chapter" data-level="6.4.2" data-path="calcs-basic.html"><a href="calcs-basic.html#rerun-calculate_scores.r"><i class="fa fa-check"></i><b>6.4.2</b> Rerun <code>calculate_scores.r</code></a></li>
<li class="chapter" data-level="6.4.3" data-path="calcs-basic.html"><a href="calcs-basic.html#explore-configure_toolbox.r"><i class="fa fa-check"></i><b>6.4.3</b> Explore <code>configure_toolbox.r</code></a></li>
</ul></li>
<li class="chapter" data-level="6.5" data-path="calcs-basic.html"><a href="calcs-basic.html#explore-a-goal-model-in-functions.r"><i class="fa fa-check"></i><b>6.5</b> Explore a goal model in <code>functions.r</code></a><ul>
<li class="chapter" data-level="6.5.1" data-path="calcs-basic.html"><a href="calcs-basic.html#load-specific-data-layers-with-selectlayersdata"><i class="fa fa-check"></i><b>6.5.1</b> Load specific data layers with <code>SelectLayersData()</code></a></li>
<li class="chapter" data-level="6.5.2" data-path="calcs-basic.html"><a href="calcs-basic.html#calculate-status"><i class="fa fa-check"></i><b>6.5.2</b> Calculate status</a></li>
<li class="chapter" data-level="6.5.3" data-path="calcs-basic.html"><a href="calcs-basic.html#calculate-trend"><i class="fa fa-check"></i><b>6.5.3</b> Calculate trend</a></li>
<li class="chapter" data-level="6.5.4" data-path="calcs-basic.html"><a href="calcs-basic.html#scores-variable-combining-status-and-trend"><i class="fa fa-check"></i><b>6.5.4</b> Scores variable: combining status and trend</a></li>
</ul></li>
<li class="chapter" data-level="6.6" data-path="calcs-basic.html"><a href="calcs-basic.html#tailor-goal-model-using-original-data-layers"><i class="fa fa-check"></i><b>6.6</b> Tailor goal model using original data layers</a></li>
<li class="chapter" data-level="6.7" data-path="calcs-basic.html"><a href="calcs-basic.html#tailor-goal-model-using-new-data-layers"><i class="fa fa-check"></i><b>6.7</b> Tailor goal model using new data layers</a><ul>
<li class="chapter" data-level="6.7.1" data-path="calcs-basic.html"><a href="calcs-basic.html#save-and-register-a-new-prepared-data-layer."><i class="fa fa-check"></i><b>6.7.1</b> Save and register a new prepared data layer.</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="calcs-advanced.html"><a href="calcs-advanced.html"><i class="fa fa-check"></i><b>7</b> Calculations: advanced workflow</a><ul>
<li class="chapter" data-level="7.1" data-path="calcs-advanced.html"><a href="calcs-advanced.html#changing-subgoals"><i class="fa fa-check"></i><b>7.1</b> Changing subgoals</a><ul>
<li class="chapter" data-level="7.1.1" data-path="calcs-advanced.html"><a href="calcs-advanced.html#update-goal-call-in-goals.csv"><i class="fa fa-check"></i><b>7.1.1</b> Update goal call in <code>goals.csv</code></a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="updating-your-website.html"><a href="updating-your-website.html"><i class="fa fa-check"></i><b>8</b> Updating your website</a><ul>
<li class="chapter" data-level="8.1" data-path="updating-your-website.html"><a href="updating-your-website.html#overview-4"><i class="fa fa-check"></i><b>8.1</b> Overview</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Ocean Health Index Toolbox Training</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="calcs-basic" class="section level1">
<h1><span class="header-section-number">Chapter 6</span> Calculations: basic workflow</h1>
<div id="overview-3" class="section level2">
<h2><span class="header-section-number">6.1</span> Overview</h2>
<p>This is a 2-hour hands-on training. All training materials are below, and can also serve as a self-paced workshop without guided instruction.</p>
<p>This training will introduce you to the workflow required to calculate OHI scores. Calculating scores requires the <code>ohicore</code> package working properly with your tailored repository. Your tailored repository will have information specific to your assessment, including formatted data layers and goal models that are written as <code>R</code> functions, and <code>ohicore</code> will perform core operations by checking your configuration before beginning calculations.</p>
<div class="figure">
<img src="https://docs.google.com/drawings/d/1wGK68NRn5bmhZo_gC2A9sx-AcpIZHVp45ID5_HQKVJ0/pub?w=768&amp;h=192" />

</div>
<!---
TODO `@jules32`: (keep this?)

    - single goal model with updated data, basically line-by-line to understand the architecture of goal models (access the correct data layers, calc status, calc trend, make sure the final output is standard for what the `scores variables` need. 
    - then calculate all goal models and scores, including pressures, and resilience. 
    - introduce which data layer we modified and which goal model we are using as an example AO
    - a lot of shuffling and bookkeeping. 
    - runs the status, trend in functions.r, but also calculates pressures, resilience, lfs, and overall scores. 
    - score.csv updated, check that in Git tab of RStudio
     book keeping, 
--->
<div id="prerequisites" class="section level3">
<h3><span class="header-section-number">6.1.1</span> Prerequisites</h3>
<p>Before we begin, make sure you have done the following:</p>
<ol style="list-style-type: decimal">
<li>RStudio is configured with Git/GitHub, and you have an up-to-date version of R and RStudio (Chapter <a href="datascience.html#datascience">3</a>)</li>
<li>Fork the <strong>toolbox-demo</strong> repository into your own GitHub account by going to <a href="https://github.com/OHI-Science/toolbox-demo" class="uri">https://github.com/OHI-Science/toolbox-demo</a>, clicking “Fork” in the upper right corner, and selecting your account</li>
<li>Clone the <strong>toolbox-demo</strong> repo from your GitHub account into RStudio</li>
<li>Get comfortable: be set up with two screens if possible. You will be following along in RStudio on your own computer while also watching an instructor’s screen or following this tutorial.</li>
</ol>
</div>
</div>
<div id="review-the-toolbox-file-ecosystem" class="section level2">
<h2><span class="header-section-number">6.2</span> Review the Toolbox file ecosystem</h2>
<!--- TODO `@ningningj`: toolbox_ecosystem.rmd--->
<p>This was covered in Chapter <a href="toolbox.html#toolbox">4</a>. In our <strong>toolbox-demo</strong> repo, we have a scenario folder called <strong>region2016</strong>. Remember that the ecosystem structure of any OHI assessment is the same, so as you learn to navigate through and calculate scores in the <strong>toolbox-demo</strong> repository you are also learning how to navigate through and calculate scores in any other OHI assessment repository — yours or anyone else’s.</p>
<div id="run-install_ohicore.r" class="section level3">
<h3><span class="header-section-number">6.2.1</span> Run <code>install_ohicore.r</code></h3>
<p>If you don’t already hav <code>ohicore</code> installed, let’s do that now. <code>ohicore</code> is an R package developed by the OHI team that has all the essential core functions and supporting packages you will use to develop your assessment and calculate scores. You will install <code>ohicore</code> one time and then load its library from the <code>toolbox-training</code> repository whenever you work on your assessment to gain access to all those functions and packages.</p>
<p>Let’s open and source <code>install_ohicore.r</code>. Learn more about <code>ohicore</code> in Chapter X. <!---TODO:: where would a section on ohicore go? Maybe need to make a vingette for it and link to it but not have a section here.---></p>
</div>
</div>
<div id="run-calculate_scores.r" class="section level2">
<h2><span class="header-section-number">6.3</span> Run <code>calculate_scores.r</code></h2>
<p><code>calculate_scores.r</code> is a script that you’ll run a lot — both as a whole and piece-by-piece. It will load the libraries you need and <code>ohicore</code> will check your book-keeping and configuration, calculate OHI scores, and ultimately save the scores for each goal and dimension in <code>scores.csv</code>. The ‘dimensions’ of OHI goal scores are Status, Trend, Pressures, Resilience, Likely Future State, and overall goal Score. Dimensions are calculated for each goal in a specific order, as we will see below. <code>calculate_scores.r</code> will combine information from your tailored repository (your data layers, Status and Trend models, pressures and resilience matrices), and calculate scores with OHI core functions from <code>ohicore</code>.</p>
<p>Open <code>calculate_scores.r</code> after navigating into the <code>region2016</code> folder.</p>
<div class="figure">
<img src="https://docs.google.com/drawings/d/1uMcbzmBRgjxKVgRqLYnxpbOGIJrm1AbMw7D3E-dUFzk/pub?w=960&amp;h=720" />

</div>
<div id="source-configure_toolbox.r" class="section level3">
<h3><span class="header-section-number">6.3.1</span> Source <code>configure_toolbox.R</code></h3>
<p>We will start by <strong>sourcing <code>configure_toolbox.R</code></strong>.</p>
<p>There is output printed to the console that lists all of the layers registered, and ends with any warning messages about the layers themselves. We will explore what is happening in <code>configure_toolbox.r</code> and how to interpret these warning messages further on; for now, let’s move on since we have not encountered an error.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## run the configure_toolbox.r script to check configuration
<span class="kw">source</span>(<span class="st">&#39;~/github/toolbox-demo/region2016/configure_toolbox.r&#39;</span>)

<span class="co">#   cc_acid</span>
<span class="co">#   cc_slr</span>
<span class="co"># ...</span>
<span class="co">#   tr_travelwarnings</span>
<span class="co"># Warning messages:</span>
<span class="co"># 1: In ohicore::CheckLayers(&quot;layers.csv&quot;, &quot;layers&quot;, flds_id = conf$config$layers_id_fields) :</span>
<span class="co">#   Unused fields...</span>
<span class="co">#     ico_spp_iucn_status: iucn_sid</span>
<span class="co"># 2: In ohicore::CheckLayers(&quot;layers.csv&quot;, &quot;layers&quot;, flds_id = conf$config$layers_id_fields) :</span>
<span class="co">#   Rows duplicated...</span>
<span class="co">#     ico_spp_iucn_status: 816</span></code></pre></div>
</div>
<div id="run-calculateall" class="section level3">
<h3><span class="header-section-number">6.3.2</span> Run <code>CalculateAll()</code></h3>
<p>Now let’s <strong>run <code>CalculateAll()</code></strong> and discuss the output. Notice too that we are saving the output to a variable called <code>scores</code>.</p>
<blockquote>
<p>Note: the prefix <code>ohicore::</code> is a way to be explicit that the <code>CalculateAll()</code> is part of the <code>ohicore</code> package.</p>
</blockquote>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## calculate scenario scores
scores =<span class="st"> </span>ohicore<span class="op">::</span><span class="kw">CalculateAll</span>(conf, layers)</code></pre></div>
<p><code>CalculateAll()</code> first calculates the Status and Trend for every goal and subgoal. These models are in your tailored repository’s <code>functions.r</code> (we will explore <code>functions.r</code> below). You can choose to add messages to print during calculation like is shown below for Mariculture (MAR).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Running Setup()...</span>
<span class="co"># Calculating Status and Trend for each region for FIS...</span>
<span class="co"># Calculating Status and Trend for each region for MAR...</span>
<span class="co"># 95th percentile for MAR ref pt is: 0.0758396517531756</span>
<span class="co"># ... </span></code></pre></div>
<p>Next, we see output as <code>CalculateAll()</code> calculates Pressures and Resilience based on the pressures and resilience matrix tables in your tailored repository. For each, <code>ohicore</code> lists the subcategories that will be calculated, and identifies any mis-matches between data layers identified but not used or missing. We will learn more about the pressures and resilience matrices later on. <!---TODO: need to develop the pressures/resilience section---></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Calculating Pressures for each region...</span>

<span class="co"># There are 6 pressures subcategories: pollution, alien_species, habitat_destruction, fishing_pressure, climate_change, social</span>
<span class="co"># These goal-elements are in the weighting data layers, but not included in the pressure_matrix.csv:</span>
<span class="co"># LIV-aqf</span>
<span class="co"># These goal-elements are in the pressure_matrix.csv, but not included in the weighting data layers:</span>
<span class="co"># CP-coral, CP-mangrove, CP-saltmarsh, CS-mangrove, CS-saltmarsh, HAB-coral, HAB-mangrove, HAB-saltmarsh, HAB-seagrass, LIV-ph, LIV-tran, CP-seaice_shoreline, HAB-seaice_edge, ECO-wte, LIV-wte, LIV-sb</span>


<span class="co"># Calculating Resilience for each region...</span>

<span class="co"># There are 7 Resilience subcategories: ecological, alien_species, goal, fishing_pressure, habitat_destruction, pollution, social</span>
<span class="co"># These goal-elements are in the resilience_matrix.csv, but not included in the weighting data layers:</span>
<span class="co"># CP-coral, CP-saltmarsh, CS-saltmarsh, HAB-coral, HAB-saltmarsh, HAB-seagrass, CP-mangrove, CS-mangrove, HAB-mangrove, HAB-seaice_edge, CP-seaice_shoreline</span></code></pre></div>
<p>Finally, we see output as <code>CalculateAll()</code> combines the dimensions above in several ways. It calculates the Goal Scores and Likely Future State for each goal and subgoal. Then, it calculates ‘supragoals’, which are goals that have subgoals, for example Food Provision (FP), which has the subgoals FIS (Wild-caught Fisheries) and Mariculture (MAR). Finally, it calculates the overall Index score for the entire Assessment Area using an area-weighted average.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># ...</span>
<span class="co"># Calculating Goal Score and Likely Future for each region for FIS...</span>
<span class="co"># Calculating Goal Score and Likely Future for each region for MAR...</span>
<span class="co"># ...</span>
<span class="co"># Calculating post-Index function for each region for FP...</span>
<span class="co"># Calculating post-Index function for each region for LE...</span>
<span class="co"># Calculating Index score for each region for supragoals using goal weights...</span>
<span class="co"># Calculating Likely Future State for each region for supragoals using goal weights...</span>
<span class="co"># Calculating scores for ASSESSMENT AREA (region_id=0) by area weighting...</span>
<span class="co"># Calculating FinalizeScores function...</span></code></pre></div>
<p>Following all the calculations are the warning messages, which are due to operations within <code>functions.r</code>, which you will be able to fix as you tailor your goal models. These warning messages are due to using goal models from the global assessment with just a subset of data from the global assessment we have extracted here for the <strong>toolbox-demo</strong> repository.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Warning messages:</span>
<span class="co"># 1: In left_join_impl(x, y, by$x, by$y, suffix$x, suffix$y) :</span>
<span class="co">#   joining factors with different levels, coercing to character vector</span>
<span class="co"># ...</span>
<span class="co"># 8: In max(d$x, na.rm = T) :</span>
<span class="co">#   no non-missing arguments to max; returning -Inf</span></code></pre></div>
</div>
<div id="save-scores-variable-as-scores.csv" class="section level3">
<h3><span class="header-section-number">6.3.3</span> Save scores variable as <code>scores.csv</code></h3>
<p>Finally, we will save the output from <code>CalculateAll()</code>, a variable called <code>scores</code>, as a comma-separated-value file called <code>scores.csv</code>. We can inspect it and see that it is a long-formatted file with four columns for the goal, dimension, numeric region identifier, and score.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## save scores as scores.csv
<span class="kw">write.csv</span>(scores, <span class="st">&#39;scores.csv&#39;</span>, <span class="dt">na=</span><span class="st">&#39;&#39;</span>, <span class="dt">row.names=</span>F)</code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">goal</th>
<th align="left">dimension</th>
<th align="right">region_id</th>
<th align="right">score</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">AO</td>
<td align="left">future</td>
<td align="right">0</td>
<td align="right">92.85</td>
</tr>
<tr class="even">
<td align="left">AO</td>
<td align="left">future</td>
<td align="right">1</td>
<td align="right">92.85</td>
</tr>
<tr class="odd">
<td align="left">AO</td>
<td align="left">future</td>
<td align="right">2</td>
<td align="right">92.85</td>
</tr>
<tr class="even">
<td align="left">…</td>
<td align="left">…</td>
<td align="right">…</td>
<td align="right">…</td>
</tr>
<tr class="odd">
<td align="left">AO</td>
<td align="left">future</td>
<td align="right">17</td>
<td align="right">92.85</td>
</tr>
<tr class="even">
<td align="left">AO</td>
<td align="left">pressures</td>
<td align="right">1</td>
<td align="right">37.75</td>
</tr>
<tr class="odd">
<td align="left">AO</td>
<td align="left">pressures</td>
<td align="right">2</td>
<td align="right">37.75</td>
</tr>
<tr class="even">
<td align="left">…</td>
<td align="left">…</td>
<td align="right">…</td>
<td align="right">…</td>
</tr>
</tbody>
</table>
<p>We have 17 regions in the <strong>toolbox-demo</strong> repo. An additional region 0 is the area-weighted combination of all regions.</p>
<blockquote>
<p>Note: each region in your assessment will have a numeric region identifer, called a <code>region_id</code> or <code>rgn_id</code> for short. You can see a list of all regions and corresponding identifiers in <a href="https://github.com/OHI-Science/toolbox-demo/blob/master/region2016/spatial/regions_list.csv">toolbox-demo/region2016/spatial/regions_list.csv</a></p>
</blockquote>
</div>
<div id="recap-of-what-just-happened" class="section level3">
<h3><span class="header-section-number">6.3.4</span> Recap of what just happened</h3>
<p>We have just successfully run through the basic workflow to calculate OHI scores. We will build on this basic workflow, by exploring the operations above in more detail, and by updating the data, models, and configurations within the <strong>toolbox-demo</strong> repository.</p>
</div>
<div id="a-note-about-error-messages" class="section level3">
<h3><span class="header-section-number">6.3.5</span> A note about error messages</h3>
<p>Hopefully this first time through <code>calculate_scores.r</code> you did not encounter error messages, but you definitely will as you move ahead. Error messages are often due to typos or miscommunications between what you tell <code>R</code> versus what it expects. You will encounter error messages due to <code>R</code> itself, and due to <code>ohicore</code>. Error messages often have human-friendly messages to alert you to what went wrong, and we are continually improving error messages you’ll encounter when you use <code>ohicore</code> so you can try to solve them more easily. Some commonly occurring errors and how to fix them can be found in the Troubleshooting section of the manual. Copy-pasting error messages into Google is also one of the best places to start.</p>
</div>
</div>
<div id="tailor-a-data-layer-and-rerun-calculate_scores.r" class="section level2">
<h2><span class="header-section-number">6.4</span> Tailor a data layer and rerun <code>calculate_scores.r</code></h2>
<p>In this example, we will substitute a single global data layer with the same layername (although different data file) with local data and recalculate scores without modifying the goal model itself. The @ref(calcs_advanced) chapter will show an example for updating goal models.</p>
<p>It’s always a good idea to Restart <code>R</code> before you begin something like this to make sure you don’t have any variables loaded that will cause problems later on.</p>
<div id="save-and-register-prepared-data-layer" class="section level3">
<h3><span class="header-section-number">6.4.1</span> Save and register prepared data layer</h3>
<!-- TODO `@ningningj`: -->
<!-- - make a simple, fake toolbox-demo/prep/AO/prep_AO.R. with last step: save in layers folder. (probably keep it simple, not as a full .Rmd. and [here](https://github.com/OHI-Science/toolbox-demo/blob/master/region2016/spatial/regions_list.csv) are the regions for the toolbox-demo repo.  -->
<!-- - and register it too, briefly.   -->
<p><code>@jules32</code>: I modified an exisiting global data layer from layers folder, instead of simplifying bhi’s ao_prep because in bhi example, new layers would require us to modify the goal models as well, which we are not ready to do in this tutorial yet. –&gt;</p>
<div id="save-data-layer" class="section level4">
<h4><span class="header-section-number">6.4.1.1</span> Save data layer</h4>
<p>As the last step of <a href="link%20to%20data_prep">data prep</a>, we save the newly modified or created data layer in layers folder and register it so that the toolbox knows where to find it. Let’s use AO as an example and practice saving and registering your new data.</p>
<p>Open <code>toolbox-demo/prep/AO/ao_prep.Rmd</code> and follow instructions there to save a data layer. Come back to this tutorial after that’s done, and we’ll continue on to registering the layer.</p>
</div>
<div id="register-a-data-layer" class="section level4">
<h4><span class="header-section-number">6.4.1.2</span> Register a data layer</h4>
<p>Now you have prepared the data layer(s), let’s register it in <code>layers.csv</code>.</p>
<p><code>layers.csv</code>is where the toolbox keeps a record of all data layers - which goal they are used for, file name, column names, etc. It directs the toolbox to access data layers from appropriate places.</p>
<p>Usually, when you create a new data layer, you’ll add a new row in the spreadsheet and fill in the first eight columns (columns A-H), as explained <a href="http://ohi-science.org/manual/#register-data-layers-in-layers.csv">here</a>. But in this excercise, for simiplicity, we modified an existing data layer and renamed it, and you only need to change the “filename”.</p>
<p>Open <code>region2016/layers.csv</code> in a spreadsheet software (i.e. Microsoft Excel), and we will replace the “filename” for “ao_access” layer to the new data layer you just saved - “ao_access_demo2017.csv”.</p>
</div>
</div>
<div id="rerun-calculate_scores.r" class="section level3">
<h3><span class="header-section-number">6.4.2</span> Rerun <code>calculate_scores.r</code></h3>
<ul>
<li>see that now <code>scores.csv</code> shows up in the git window. Great way to check your work. Which goal do you expect to change?</li>
<li>and layers.csv, and your layers file</li>
</ul>
<p><strong>Checking your work:</strong> Whenever there are changes made (addition, deletion, changes in .csv or r script), you will be notified in the Git window, since Git is tracking changes to your work. So here, since you added a new data layer, and also expect changes to AO scores in <code>score.csv</code>. This is a good place to double check whether you have made the right changes.</p>
</div>
<div id="explore-configure_toolbox.r" class="section level3">
<h3><span class="header-section-number">6.4.3</span> Explore <code>configure_toolbox.r</code></h3>
<p>So now let’s take a closer look, let’s check out <code>configure_toolbox.r</code>, the first thing that runs.</p>
<p><code>configure_toolbox.r</code> combines everything required to calculate OHI scores and checks that they are properly formatted, and will minimize potential errors later on. It makes sure that your data and goal models are ready to be used to calculate scores.</p>
<div class="figure">
<img src="https://docs.google.com/drawings/d/1WvHfWe06D2x9cKB7vhWrmvmxuRpmGvzsMs9AjS23g3E/pub?h=450" />

</div>
<blockquote>
<p>Any time you make a change to a data layer or a goal model and want to recalculate scores, you will need to re-run <code>configure_toolbox.r</code> to have <code>ohicore</code> operate on the most up-to-date information. You can click “Source” to run all the lines:</p>
</blockquote>
<blockquote>
<div class="figure">
<img src="https://docs.google.com/drawings/d/1JvSJKyiwvp92--obTwHT3IYht1XE0823sORJ4FdnX74/pub?h=450" />

</div>
</blockquote>
<div id="load-libraries-and-set-working-directory" class="section level4">
<h4><span class="header-section-number">6.4.3.1</span> Load libraries and set working directory</h4>
<!-- TODO `@ningningj`: check this to see it's complete and a similar to style in the `Run calculate_scores.r section` above -->
<!-- Also, if you are requiring other libraries as you develop your own goal models, this would be the place to load them.  -->
<p>The first two steps set up your working environment: - load <code>ohicore</code> and R packages (eg. tidyerse, stringr) - set working directory to your repository</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## load ohicore and tidyverse (includes dplyr, tidyr, stringr, etc)
<span class="cf">if</span> (<span class="op">!</span><span class="st">&quot;ohicore&quot;</span> <span class="op">%in%</span><span class="st"> </span>(<span class="kw">.packages</span>())) {
  <span class="kw">suppressWarnings</span>(<span class="kw">require</span>(ohicore))
  <span class="kw">library</span>(tidyverse)    <span class="co"># install.packages(&#39;tidyverse&#39;)</span>
  <span class="kw">library</span>(stringr)
}

## set working directory to the scenario that contains conf and layers directories
<span class="kw">setwd</span>(<span class="st">&#39;~/github/toolbox-demo/region2016&#39;</span>)</code></pre></div>
</div>
<div id="ohicoreconf" class="section level4">
<h4><span class="header-section-number">6.4.3.2</span> <code>ohicore::Conf()</code></h4>
<p>This function prepares for the next steps of running the toolbox, and calls forth everything you need to calculate scores:</p>
<ul>
<li>all data layers (for goals, pressures, resilience)</li>
<li>goal functions, and</li>
<li>other OHI parameters that determines how ohi scores are calculated</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## load scenario configuration
conf =<span class="st"> </span>ohicore<span class="op">::</span><span class="kw">Conf</span>(<span class="st">&#39;conf&#39;</span>)</code></pre></div>
</div>
<div id="ohicorechecklayers" class="section level4">
<h4><span class="header-section-number">6.4.3.3</span> <code>ohicore::CheckLayers()</code></h4>
<p>This function checks that data layers are properly formatted and registered (e.g., that each datalayer in layers.csv is present in the layers folder, etc.), and returns a list of all of the layers that are registered. Check to make sure ours is there. This is a gate-keeping step by to make sure the data layers you’ve entered are in the right format and can be read by <code>ohicore</code> properly.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## check that scenario layers files in the \layers folder match layers.csv registration. Layers files are not modified.
ohicore<span class="op">::</span><span class="kw">CheckLayers</span>(<span class="st">&#39;layers.csv&#39;</span>, <span class="st">&#39;layers&#39;</span>, <span class="dt">flds_id=</span>conf<span class="op">$</span>config<span class="op">$</span>layers_id_fields)</code></pre></div>
<p>Warning messages alert you to problems with specific layers: this is showing that there are duplicates in a status layer. These warning messages are not a problem now (they are a byproduct of extracting this repo based on Global OHI assessments; you’ll be changing this layer anyways).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">Warning messages<span class="op">:</span>
<span class="dv">1</span><span class="op">:</span><span class="st"> </span>In ohicore<span class="op">::</span><span class="kw">CheckLayers</span>(<span class="st">&quot;layers.csv&quot;</span>, <span class="st">&quot;layers&quot;</span>, <span class="dt">flds_id =</span> conf<span class="op">$</span>config<span class="op">$</span>layers_id_fields) <span class="op">:</span>
<span class="st">  </span>Unused fields...
    ico_spp_iucn_status<span class="op">:</span><span class="st"> </span>iucn_sid
<span class="dv">2</span><span class="op">:</span><span class="st"> </span>In ohicore<span class="op">::</span><span class="kw">CheckLayers</span>(<span class="st">&quot;layers.csv&quot;</span>, <span class="st">&quot;layers&quot;</span>, <span class="dt">flds_id =</span> conf<span class="op">$</span>config<span class="op">$</span>layers_id_fields) <span class="op">:</span>
<span class="st">  </span>Rows duplicated...
    ico_spp_iucn_status<span class="op">:</span><span class="st"> </span><span class="dv">816</span></code></pre></div>
<p>You’ll also encounter error messages as you develop your own assessment. These messages intend to alert you that there are errors in data entry. Some common errors are:</p>
<ul>
<li>improper formatting or missing columns in your data layer</li>
<li>typos or misnamed columns</li>
</ul>
</div>
<div id="ohicorelayers" class="section level4">
<h4><span class="header-section-number">6.4.3.4</span> <code>ohicore::Layers()</code></h4>
<p>TODO: explain</p>
<p>This function creates an R object that combines into a single object all the information from the layers files and the layers.csv metadata. Individual layers can be accessed as: layers<span class="math inline">\(data\)</span>layer_name???</p>
<blockquote>
<p>Note: <code>@jules32</code>: describe this vs. SelectLayersData()</p>
</blockquote>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## load scenario layers for ohicore to access. Layers files are not modified.
layers =<span class="st"> </span>ohicore<span class="op">::</span><span class="kw">Layers</span>(<span class="st">&#39;layers.csv&#39;</span>, <span class="st">&#39;layers&#39;</span>)

<span class="co"># (no output)</span></code></pre></div>
</div>
</div>
</div>
<div id="explore-a-goal-model-in-functions.r" class="section level2">
<h2><span class="header-section-number">6.5</span> Explore a goal model in <code>functions.r</code></h2>
<p>Remember from <code>calculate_scores.r</code> that after configure_toolbox, the next thing that happens is that CalculateScores() runs through the goal models and calcuates status and trend. Status and Trend calculations are contained in <code>functions.r</code> in the <code>conf</code> folder.</p>
<div class="figure">
<img src="https://docs.google.com/drawings/d/1CKNjIORLJOEaV2XW4Z9QuFLN7q1lJ1PaEGg2dSG1-_o/pub?h=450" />

</div>
<p><code>functions.r</code> is a big list of all goal models in the assessment, each as its own <code>R</code> function. You can run all of them at the once or each individually. <strong>Each goal model is an individual R function that calculates status and trend, and you will modify the goal model within the confines of each function</strong>. Let’s look at the goal models for Artisanal Fishing Opportunity (AO) as an example. It has models developed from the most recent global assessment as a place for you to start.</p>
<blockquote>
<p><strong>Tip</strong>: Clicking the bottom left corner of Console will show you a drop-down menu of all functions. It’s a shortcut to jump to the appropriate section or goal model</p>
</blockquote>
<blockquote>
<div class="figure">
<img src="https://docs.google.com/drawings/d/1Z2AVtVfIZEd_5GDcmaLb8mRpErKTDzmcbg0SBMxKsxs/pub?h=450" />

</div>
</blockquote>
<p>The following things happen in each goal model:</p>
<ul>
<li>load specific data layers (using <code>ohicore::SelectLayersData()</code>)</li>
<li>calculate status scores</li>
<li>calculate trend scores</li>
<li>combine status and trend scores</li>
<li>format and return the <code>scores</code></li>
</ul>
<div id="load-specific-data-layers-with-selectlayersdata" class="section level3">
<h3><span class="header-section-number">6.5.1</span> Load specific data layers with <code>SelectLayersData()</code></h3>
<p><code>SelectLayersData()</code> is an <code>ohicore</code> function to call the appropriate data layers by its layer name registered in <code>layers.csv</code> (eg. “ao_access”) Run this chunk of code and the data layers will be loaded, joined, and ready to be manipulated further:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## &quot;select&quot;&quot; is a function from the dplyr package to let you select only the columns you would need

r &lt;-<span class="st"> </span><span class="kw">SelectLayersData</span>(layers, <span class="dt">layers =</span> <span class="st">&#39;ao_access&#39;</span>, <span class="dt">narrow=</span><span class="ot">TRUE</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">select</span>(<span class="dt">region_id=</span>id_num, <span class="dt">access=</span>val_num)
r &lt;-<span class="st"> </span><span class="kw">na.omit</span>(r)

ry &lt;-<span class="st"> </span><span class="kw">SelectLayersData</span>(layers, <span class="dt">layers =</span> <span class="st">&#39;ao_need&#39;</span>, <span class="dt">narrow=</span><span class="ot">TRUE</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">select</span>(<span class="dt">region_id =</span> id_num, year, <span class="dt">need=</span>val_num) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">left_join</span>(r, <span class="dt">by=</span><span class="st">&quot;region_id&quot;</span>)</code></pre></div>
<blockquote>
<p>Tip: it’s always a good idea to check what your data looks like and make sure there are no glaring errors. A couple of commonly used functions are: head() and str()</p>
</blockquote>
</div>
<div id="calculate-status" class="section level3">
<h3><span class="header-section-number">6.5.2</span> Calculate status</h3>
<p>Once you make sure your data layer has been loaded and joined in the right format, you can start calculate status scores!</p>
<!-- **TODO `@ningningj`: this syntax uses the `tidyverse` and chaining...look xxx to learn more**  -->
<p>This syntax uses the <code>tidyverse</code> package that you loaded in <code>configure_toolbox.r</code>. It contains the commonly- used, data-wrangling functions you’ll need in almost every analysis, and enables chaining (ie. %&gt;%). We’ll briefly explain some of the functions below as we encounter them.</p>
<p>To learn more, take a look at <a href="http://tidyverse.org/">tidyverse.org</a>. This <a href="https://www.rstudio.com/wp-content/uploads/2015/02/data-wrangling-cheatsheet.pdf">cheatsheet</a> is also a helpful guide with quick references to each function.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># model: this step calculates status scores of all years, using the goal model. </span>

## &quot;mutate&quot; is another commonly used function from dplyr that allows you to add a new column to the data frame
## Note that &quot;Sustainability&quot; and &quot;status_year&quot; have been defined at the start of the AO function 
  Sustainability=<span class="fl">1.0</span>
  status_year =<span class="st"> </span><span class="dv">2015</span>

  ry &lt;-<span class="st"> </span>ry <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">Du =</span> (<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>need) <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>access)) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">status =</span> (<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>Du) <span class="op">*</span><span class="st"> </span>Sustainability)

<span class="co"># status: status scores are typically the most recent year of all the years you have calculated. </span>

  r.status &lt;-<span class="st"> </span>ry <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">filter</span>(year<span class="op">==</span>status_year) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">select</span>(region_id, status) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">status=</span>status<span class="op">*</span><span class="dv">100</span>)</code></pre></div>
</div>
<div id="calculate-trend" class="section level3">
<h3><span class="header-section-number">6.5.3</span> Calculate trend</h3>
<p>Trend scores are typically based on linear regression of status scores from the most recent five years.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"> <span class="co"># choose trend years (eg. most recent five years)</span>

  trend_years &lt;-<span class="st"> </span>(status_year<span class="op">-</span><span class="dv">4</span>)<span class="op">:</span>(status_year)
  adj_trend_year &lt;-<span class="st"> </span><span class="kw">min</span>(trend_years)

  r.trend =<span class="st"> </span>ry <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">group_by</span>(region_id) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="co"># linear model: </span>
<span class="st">    </span><span class="kw">do</span>(<span class="dt">mdl =</span> <span class="kw">lm</span>(status <span class="op">~</span><span class="st"> </span>year, <span class="dt">data=</span>., <span class="dt">subset=</span>year <span class="op">%in%</span><span class="st"> </span>trend_years),
       <span class="dt">adjust_trend =</span> .<span class="op">$</span>status[.<span class="op">$</span>year <span class="op">==</span><span class="st"> </span>adj_trend_year]) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="co"># extract the coefficient of year and produce a trend score</span>
<span class="st">    </span><span class="kw">summarize</span>(region_id, <span class="dt">trend =</span> <span class="kw">ifelse</span>(<span class="kw">coef</span>(mdl)[<span class="st">&#39;year&#39;</span>]<span class="op">==</span><span class="dv">0</span>, <span class="dv">0</span>, <span class="kw">coef</span>(mdl)[<span class="st">&#39;year&#39;</span>]<span class="op">/</span>adjust_trend <span class="op">*</span><span class="st"> </span><span class="dv">5</span>)) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="co"># make sure that the scores are between -1 and 1</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">trend =</span> <span class="kw">ifelse</span>(trend<span class="op">&gt;</span><span class="dv">1</span>, <span class="dv">1</span>, trend)) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">trend =</span> <span class="kw">ifelse</span>(trend<span class="op">&lt;</span>(<span class="op">-</span><span class="dv">1</span>), (<span class="op">-</span><span class="dv">1</span>), trend)) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">trend =</span> <span class="kw">round</span>(trend, <span class="dv">4</span>))</code></pre></div>
</div>
<div id="scores-variable-combining-status-and-trend" class="section level3">
<h3><span class="header-section-number">6.5.4</span> Scores variable: combining status and trend</h3>
<p>Choose only region_id and score, and add two more columns identifying score dimension (status or trend) and goal name.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"> scores =<span class="st"> </span>r.status <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">select</span>(region_id, <span class="dt">score=</span>status) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">dimension=</span><span class="st">&#39;status&#39;</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">rbind</span>(
      r.trend <span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">select</span>(region_id, <span class="dt">score=</span>trend) <span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">mutate</span>(<span class="dt">dimension=</span><span class="st">&#39;trend&#39;</span>)) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">goal=</span><span class="st">&#39;AO&#39;</span>)</code></pre></div>
<p>The scores variable is something that you’ll see at the end of every goal model; <code>ohicore</code> will combine these all together when <code>CalculateAll()</code> runs.</p>
</div>
</div>
<div id="tailor-goal-model-using-original-data-layers" class="section level2">
<h2><span class="header-section-number">6.6</span> Tailor goal model using original data layers</h2>
<p>Modifying a goal model involves editing the operations within that goal’s model in <code>functions.r</code>.</p>
<p>First let’s restart R and source <code>configure_toolbox.r</code>. We can do this from either <code>calculate_scores.r</code> or from <code>configure_toolbox.r</code> itself.</p>
<p>Now, let’s go to <code>functions.r</code> and go back to the AO model. Let’s do something pretty simple to tailor the goal model. Let’s say we just wanted to divide the variable <code>Du</code> by 2 in the equation.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"> ry &lt;-<span class="st"> </span>ry <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">Du =</span> (<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>need) <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>access)) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">status =</span> (<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>Du<span class="op">/</span><span class="dv">2</span>) <span class="op">*</span><span class="st"> </span>sustainability)</code></pre></div>
<p>We can run the rest of the AO function line-by-line and inspect the scores variable at the end to see if everything looks OK.</p>
<p>It looks OK to me, so let’s run the rest of <code>calculate_scores.r</code>, and use Git’s differencing feature to see how our scores have changed. This is a great way to double-check and error-check that things are working the way you expected.</p>
</div>
<div id="tailor-goal-model-using-new-data-layers" class="section level2">
<h2><span class="header-section-number">6.7</span> Tailor goal model using new data layers</h2>
<p>Now, we are going to tailor a goal model by adding a new data layer, so it’s the combination of what we’ve gone through above.</p>
<div id="save-and-register-a-new-prepared-data-layer." class="section level3">
<h3><span class="header-section-number">6.7.1</span> Save and register a new prepared data layer.</h3>
<p>TODO: create another AO prep.r</p>
<p>Now, to register this layer, we’ll need to add a new row to <code>layers.csv</code></p>
<p>Now, in <code>functions.r</code>, we’ll need to use SelectLayersData() to access your new layer, and then use it in a calculation, using the same workflow from above.</p>
<p>end 2-hour tutorial.</p>
<!---next steps after Eva training: 

## Update pressures and resilience matrices

- PlotFlower, PlotMap
- updating pressures/resilience matrices


--->

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="prep-data.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="calcs-advanced.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    if (location.protocol !== "file:" && /^https?:/.test(script.src))
      script.src  = script.src.replace(/^https?:/, '');
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
