<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Ocean Health Index Toolbox Training</title>
  <meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
  <meta name="description" content="This is the official Ocean Health Index Toolbox training.">
  <meta name="generator" content="bookdown 0.3 and GitBook 2.6.7">

  <meta property="og:title" content="Ocean Health Index Toolbox Training" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is the official Ocean Health Index Toolbox training." />
  <meta name="github-repo" content="ohi-science/ohi-trainings" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Ocean Health Index Toolbox Training" />
  
  <meta name="twitter:description" content="This is the official Ocean Health Index Toolbox training." />
  

<meta name="author" content="Ocean Health Index Team">


<meta name="date" content="2017-02-15">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="preparing-data.html">
<link rel="next" href="updating-your-website.html">

<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

</head>

<body>


  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Overview</a></li>
<li class="chapter" data-level="2" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>2</b> Introduction</a><ul>
<li class="chapter" data-level="2.1" data-path="index.html"><a href="index.html#overview"><i class="fa fa-check"></i><b>2.1</b> Overview</a></li>
<li class="chapter" data-level="2.2" data-path="introduction.html"><a href="introduction.html#ohi-conceptually"><i class="fa fa-check"></i><b>2.2</b> OHI conceptually</a></li>
<li class="chapter" data-level="2.3" data-path="introduction.html"><a href="introduction.html#best-practices"><i class="fa fa-check"></i><b>2.3</b> Best practices</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="workflow.html"><a href="workflow.html"><i class="fa fa-check"></i><b>3</b> Workflow</a><ul>
<li class="chapter" data-level="3.1" data-path="workflow.html"><a href="workflow.html#ohi-repo"><i class="fa fa-check"></i><b>3.1</b> OHI+ Repo</a></li>
<li class="chapter" data-level="3.2" data-path="workflow.html"><a href="workflow.html#rstudio-github-workflow"><i class="fa fa-check"></i><b>3.2</b> RStudio-GitHub workflow</a></li>
<li class="chapter" data-level="3.3" data-path="workflow.html"><a href="workflow.html#how-you-work"><i class="fa fa-check"></i><b>3.3</b> How you work</a></li>
<li class="chapter" data-level="3.4" data-path="workflow.html"><a href="workflow.html#develop-skills"><i class="fa fa-check"></i><b>3.4</b> Developing these skills</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="toolbox-ecosystem.html"><a href="toolbox-ecosystem.html"><i class="fa fa-check"></i><b>4</b> Toolbox Ecosystem</a><ul>
<li class="chapter" data-level="4.1" data-path="toolbox-ecosystem.html"><a href="toolbox-ecosystem.html#overview-1"><i class="fa fa-check"></i><b>4.1</b> Overview</a></li>
<li class="chapter" data-level="4.2" data-path="toolbox-ecosystem.html"><a href="toolbox-ecosystem.html#files-and-organization"><i class="fa fa-check"></i><b>4.2</b> Files and organization</a><ul>
<li class="chapter" data-level="4.2.1" data-path="toolbox-ecosystem.html"><a href="toolbox-ecosystem.html#functions.r"><i class="fa fa-check"></i><b>4.2.1</b> functions.r</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="toolbox-ecosystem.html"><a href="toolbox-ecosystem.html#ohicore"><i class="fa fa-check"></i><b>4.3</b> <code id="ohicore">ohicore</code></a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="preparing-data.html"><a href="preparing-data.html"><i class="fa fa-check"></i><b>5</b> Preparing data</a><ul>
<li class="chapter" data-level="5.1" data-path="preparing-data.html"><a href="preparing-data.html#overview-2"><i class="fa fa-check"></i><b>5.1</b> Overview</a></li>
<li class="chapter" data-level="5.2" data-path="preparing-data.html"><a href="preparing-data.html#data-layer-formatting"><i class="fa fa-check"></i><b>5.2</b> Data layer formatting</a></li>
<li class="chapter" data-level="5.3" data-path="preparing-data.html"><a href="preparing-data.html#data-wrangling"><i class="fa fa-check"></i><b>5.3</b> Data wrangling</a></li>
<li class="chapter" data-level="5.4" data-path="preparing-data.html"><a href="preparing-data.html#save-and-register-data-layer"><i class="fa fa-check"></i><b>5.4</b> Save and register data layer</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="calculating-scores.html"><a href="calculating-scores.html"><i class="fa fa-check"></i><b>6</b> Calculating scores</a><ul>
<li class="chapter" data-level="6.1" data-path="calculating-scores.html"><a href="calculating-scores.html#overview-3"><i class="fa fa-check"></i><b>6.1</b> Overview</a></li>
<li class="chapter" data-level="6.2" data-path="calculating-scores.html"><a href="calculating-scores.html#calculate_scores.r-workflow"><i class="fa fa-check"></i><b>6.2</b> <code>calculate_scores.r</code> workflow</a><ul>
<li class="chapter" data-level="6.2.1" data-path="calculating-scores.html"><a href="calculating-scores.html#calculate-overall-scores"><i class="fa fa-check"></i><b>6.2.1</b> Calculate overall scores</a></li>
<li class="chapter" data-level="6.2.2" data-path="calculating-scores.html"><a href="calculating-scores.html#try-it-out"><i class="fa fa-check"></i><b>6.2.2</b> Try it out</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="calculating-scores.html"><a href="calculating-scores.html#installing-ohicore"><i class="fa fa-check"></i><b>6.3</b> Installing ohicore</a></li>
<li class="chapter" data-level="6.4" data-path="calculating-scores.html"><a href="calculating-scores.html#substituting-new-data-layers"><i class="fa fa-check"></i><b>6.4</b> Substituting new data layers</a></li>
<li class="chapter" data-level="6.5" data-path="calculating-scores.html"><a href="calculating-scores.html#source-configure_toolbox.r"><i class="fa fa-check"></i><b>6.5</b> Source <code>configure_toolbox.r</code></a><ul>
<li class="chapter" data-level="6.5.1" data-path="calculating-scores.html"><a href="calculating-scores.html#explore-goal-model"><i class="fa fa-check"></i><b>6.5.1</b> Explore goal model</a></li>
<li class="chapter" data-level="6.5.2" data-path="calculating-scores.html"><a href="calculating-scores.html#selectlayersdata"><i class="fa fa-check"></i><b>6.5.2</b> SelectLayersData</a></li>
<li class="chapter" data-level="6.5.3" data-path="calculating-scores.html"><a href="calculating-scores.html#calculate-status"><i class="fa fa-check"></i><b>6.5.3</b> Calculate status</a></li>
<li class="chapter" data-level="6.5.4" data-path="calculating-scores.html"><a href="calculating-scores.html#calculate-trend"><i class="fa fa-check"></i><b>6.5.4</b> Calculate trend</a></li>
<li class="chapter" data-level="6.5.5" data-path="calculating-scores.html"><a href="calculating-scores.html#combine-status-and-trend-scores"><i class="fa fa-check"></i><b>6.5.5</b> Combine status and trend scores</a></li>
</ul></li>
<li class="chapter" data-level="6.6" data-path="calculating-scores.html"><a href="calculating-scores.html#developing-goal-models"><i class="fa fa-check"></i><b>6.6</b> Developing goal models</a><ul>
<li class="chapter" data-level="6.6.1" data-path="calculating-scores.html"><a href="calculating-scores.html#update-goal-call-in-goals.csv"><i class="fa fa-check"></i><b>6.6.1</b> Update goal call in <code>goals.csv</code>**</a></li>
</ul></li>
<li class="chapter" data-level="6.7" data-path="calculating-scores.html"><a href="calculating-scores.html#removing-goals"><i class="fa fa-check"></i><b>6.7</b> Removing goals</a></li>
<li class="chapter" data-level="6.8" data-path="calculating-scores.html"><a href="calculating-scores.html#changing-subgoals"><i class="fa fa-check"></i><b>6.8</b> Changing subgoals</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="updating-your-website.html"><a href="updating-your-website.html"><i class="fa fa-check"></i><b>7</b> Updating your website</a><ul>
<li class="chapter" data-level="7.1" data-path="updating-your-website.html"><a href="updating-your-website.html#overview-4"><i class="fa fa-check"></i><b>7.1</b> Overview</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="brainstorm.html"><a href="brainstorm.html"><i class="fa fa-check"></i><b>8</b> Brainstorm</a><ul>
<li class="chapter" data-level="8.1" data-path="brainstorm.html"><a href="brainstorm.html#overview-5"><i class="fa fa-check"></i><b>8.1</b> Overview</a><ul>
<li class="chapter" data-level="8.1.1" data-path="brainstorm.html"><a href="brainstorm.html#prerequisites"><i class="fa fa-check"></i><b>8.1.1</b> Prerequisites</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="brainstorm.html"><a href="brainstorm.html#remind-yourself-of-the-toolbox-file-ecosystem"><i class="fa fa-check"></i><b>8.2</b> Remind yourself of the Toolbox file ecosystem</a></li>
<li class="chapter" data-level="8.3" data-path="brainstorm.html"><a href="brainstorm.html#calculate_scores.r-workflow-1"><i class="fa fa-check"></i><b>8.3</b> <code>calculate_scores.r</code> workflow</a><ul>
<li class="chapter" data-level="8.3.1" data-path="brainstorm.html"><a href="brainstorm.html#run-install_ohicore.r"><i class="fa fa-check"></i><b>8.3.1</b> run <code>install_ohicore.r</code></a></li>
<li class="chapter" data-level="8.3.2" data-path="brainstorm.html"><a href="brainstorm.html#region2016calculate_scores.r"><i class="fa fa-check"></i><b>8.3.2</b> region2016/calculate_scores.r</a></li>
<li class="chapter" data-level="8.3.3" data-path="brainstorm.html"><a href="brainstorm.html#recap-of-what-just-happened"><i class="fa fa-check"></i><b>8.3.3</b> Recap of what just happened</a></li>
</ul></li>
<li class="chapter" data-level="8.4" data-path="brainstorm.html"><a href="brainstorm.html#update-a-data-layer-and-lets-see-the-whole-process-again."><i class="fa fa-check"></i><b>8.4</b> Update a data layer and let’s see the whole process again.</a><ul>
<li class="chapter" data-level="8.4.1" data-path="brainstorm.html"><a href="brainstorm.html#update-data-layer-but-with-the-same-layer-name"><i class="fa fa-check"></i><b>8.4.1</b> update data layer but with the same layer name</a></li>
<li class="chapter" data-level="8.4.2" data-path="brainstorm.html"><a href="brainstorm.html#rerun-calculate_scores.r"><i class="fa fa-check"></i><b>8.4.2</b> rerun calculate_scores.r</a></li>
</ul></li>
<li class="chapter" data-level="8.5" data-path="brainstorm.html"><a href="brainstorm.html#configure_toolbox.r"><i class="fa fa-check"></i><b>8.5</b> configure_toolbox.r</a><ul>
<li class="chapter" data-level="8.5.1" data-path="brainstorm.html"><a href="brainstorm.html#loads-libraries"><i class="fa fa-check"></i><b>8.5.1</b> loads libraries</a></li>
<li class="chapter" data-level="8.5.2" data-path="brainstorm.html"><a href="brainstorm.html#ohicoreconf"><i class="fa fa-check"></i><b>8.5.2</b> <code>ohicore::Conf()</code></a></li>
<li class="chapter" data-level="8.5.3" data-path="brainstorm.html"><a href="brainstorm.html#ohicorechecklayers"><i class="fa fa-check"></i><b>8.5.3</b> <code>ohicore::CheckLayers()</code></a></li>
<li class="chapter" data-level="8.5.4" data-path="brainstorm.html"><a href="brainstorm.html#ohicorelayers"><i class="fa fa-check"></i><b>8.5.4</b> <code>ohicore::Layers()</code></a></li>
</ul></li>
<li class="chapter" data-level="8.6" data-path="brainstorm.html"><a href="brainstorm.html#functions.r-1"><i class="fa fa-check"></i><b>8.6</b> <code>functions.r</code></a></li>
<li class="chapter" data-level="8.7" data-path="brainstorm.html"><a href="brainstorm.html#todiscuss"><i class="fa fa-check"></i><b>8.7</b> TODISCUSS</a><ul>
<li class="chapter" data-level="8.7.1" data-path="brainstorm.html"><a href="brainstorm.html#change-the-goal-model-with-the-same-data-layers"><i class="fa fa-check"></i><b>8.7.1</b> change the goal model with the same data layers</a></li>
<li class="chapter" data-level="8.7.2" data-path="brainstorm.html"><a href="brainstorm.html#add-a-new-layer-and-have-the-goal-model-use-the-new-layer"><i class="fa fa-check"></i><b>8.7.2</b> add a new layer, and have the goal model use the new layer</a></li>
</ul></li>
<li class="chapter" data-level="8.8" data-path="brainstorm.html"><a href="brainstorm.html#todiscuss-1"><i class="fa fa-check"></i><b>8.8</b> TODISCUSS</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Ocean Health Index Toolbox Training</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="calculating-scores" class="section level1">
<h1><span class="header-section-number">Chapter 6</span> Calculating scores</h1>
<div id="overview-3" class="section level2">
<h2><span class="header-section-number">6.1</span> Overview</h2>
<!---TODO `@jules32`

*TODO `@jules32`: some kind of overview like:* This chapter will take you from prepared data to calculated scores. It requires book keeping, `R` functions, and ultimately, the `R` package `ohicore`... `@jules32`: i'm not sure if we should emphasize ohicore here. it's good to quickly explain what it does later. but since people are not going to modify ohicore, and it's just running in the background essentially, mentioning it here could add unnecessary confusion... 

- *In this example, we will substitute a single global data layer with local data and recalculate scores without modifying the goal model itself. The \@ref(update) chapter will show an example for updating goal models.* 
- *screenshot of RStudio window, overview of `configure_toolbox.r` and `calculate_scores.r`, etc* 
- *bigger overview of how things work together and workflow: functions.r is a big list of goal models, as R functions. You can run all of them at the once or individually. In this chapter we will work on just one goal model*

----

TODO `@ningningj` and `@jules32`: we need to be more explicit about the overview here. 
Eg: In this chapter we're going to 
    - single goal model with updated data, basically line-by-line to understand the architecture of goal models (access the correct data layers, calc status, calc trend, make sure the final output is standard for what the `scores variables` need. 
    - then calculate all goal models and scores, including pressures, and resilience. 

- will probably need a section "what is ohicore and how does it operate with my ohi+ repo?" (see bel)
- introduce which data layer we modified and which goal model we are using as an example (eg AO)

--->
<p>TODO::</p>
<ul>
<li><code>calculate_scores.r</code> workflow, requires ohicore.</li>
<li>substituting new data layers in current goal models</li>
<li>developing goal models and adding new data layers</li>
<li>removing goals</li>
</ul>
<p>In this section, we won’t be modifying goal models yet. Instead, we will get you familiar with the construct of <code>functions.R</code> and the sequence of events required to calculate scores. This means we’ll take the data layer that you just prepared <a href="preparing-data.html#preparing-data">5</a> and follow these steps to calculate scores:</p>
<ol style="list-style-type: decimal">
<li><p>Confirm that data layers are saved and registered. See <a href="preparing-data.html#preparing-data">5</a></p></li>
<li><p>Load <code>ohicore</code> and check data layers <em>in <code>configure_toolbox.r</code></em></p></li>
<li>Calculate goal scores <em>in <code>conf/functions.r</code></em></li>
</ol>
<ul>
<li>load data (<code>functions.r</code>)</li>
<li>calculate status scores (<code>functions.r</code>)</li>
<li>calculate trend scores (<code>functions.r</code>)</li>
<li>combine status and trend scores (<code>functions.r</code>)</li>
</ul>
<ol start="3" style="list-style-type: decimal">
<li><p>check and possibly update how the function is called <em>in <code>conf/goals.csv</code></em></p></li>
<li><p>calculate the remaining component of OHI scores <em>in <code>calculate_scores.r</code></em></p></li>
</ol>
<p>We will go through each of the scripts mentioned above. Here is a general structure to show where those files are in relation to the entire calculation process:</p>
<p><strong>TODO <code>@ningningj</code>: this figure may be more clear here if the red boxes are removed and instead placed around the green top pieces “modify goal models” and “calculate scores”?</strong> <code>@jules32</code>: i didn’t do that because we are not updating pressures and resilience. but your point is totally valid. i updated the figure as below, highlighting only the steps and scripts used here. what do you think? <img src="https://docs.google.com/drawings/d/1MAIgSAFUTFg2J9XKIYBUFttOfHex5OSMbXIDlUMlKSY/pub?h=500" /></p>
<p>Now let’s get started and give it a try!</p>
</div>
<div id="calculate_scores.r-workflow" class="section level2">
<h2><span class="header-section-number">6.2</span> <code>calculate_scores.r</code> workflow</h2>
<!---TODISCUSS: I this should be the big picture, and come before the more detailed stuff below?
This is what they should be able to run immediately to see what happens. So this is the low-hanging fruit. --->
<ul>
<li>a lot of shuffling and bookkeeping.</li>
<li>what you get when you run <code>calculate_scores.r</code>
<ul>
<li>runs the status, trend in functions.r, but also calculates pressures, resilience, lfs, and overall scores.</li>
<li>score.csv updated, check that in Git tab of RStudio</li>
</ul></li>
<li>goals.csv</li>
</ul>
<div id="calculate-overall-scores" class="section level3">
<h3><span class="header-section-number">6.2.1</span> Calculate overall scores</h3>
<p><strong>TODISCUSS <code>@ningningj</code>/<code>@jules32</code>: I think we’ll want to make this a distinct thing that also includes pressures/resilience, etc, whereas they’ve just been walking through the status/trend for a single goal model above. Does that make sense? We can think of the organization…</strong></p>
<p><code>@jules32</code>: umm did you mean that it’s confusing to mention pressures/resilience here too, since we only walked through status/trend? i agree. what if we say it like this:</p>
<p>Hooray! You just walked through the status and trend calcuation for a single goal model. Let’s take a look at how adding new data layers has changed the goal score. This is done in <code>calculate_scores.r</code></p>
<div class="figure">
<img src="https://docs.google.com/drawings/d/1uMcbzmBRgjxKVgRqLYnxpbOGIJrm1AbMw7D3E-dUFzk/pub?w=960&amp;h=720" />

</div>
<p>OLD TEXT: Hooray you’ve modified a goal function! Now let’s calculate the remaining score components (pressures, resilience, likely future state, and overall score).</p>
<p><em>We’ll learn how to modify Pressures and Resilience matrix in a different chapter.</em></p>
</div>
<div id="try-it-out" class="section level3">
<h3><span class="header-section-number">6.2.2</span> Try it out</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># calculate scenario scores</span>
scores =<span class="st"> </span><span class="kw">CalculateAll</span>(conf, layers, <span class="dt">debug=</span>F)

<span class="co"># save scores as .csv file, tables and figures</span>
<span class="kw">write.csv</span>(scores, <span class="st">&#39;scores.csv&#39;</span>, <span class="dt">na=</span><span class="st">&#39;&#39;</span>, <span class="dt">row.names=</span>F)</code></pre></div>
<p>After the calculation is done, you should be able to see the compiled score sheet for all goals in all regions in sub-country/scores.csv.</p>
<p>It is very likely that during the CalculateAll process you’ll encounter problems and see error messages. In most cases, the error messages can specify what the error is and in which step it occurs, which should be helpful for trouble shooting. Some commonly occurring errors and how to fix them can be found in the Troubleshooting section of the manual.</p>
<p><em><strong>Tip</strong>: whenever there are changes made (addition, deletion, changes in .csv or r script), you would be notified in the Git window. So here, since you added a new data layer and/more modified a function, and are expecting changes in score.csv, you should see it in Git. This is a good place to double check whether you have made the right changes.</em></p>
</div>
</div>
<div id="installing-ohicore" class="section level2">
<h2><span class="header-section-number">6.3</span> Installing ohicore</h2>
<!---TODO `@jules32`: 
update and reference \@ref(ohicore)

TODISCUSS: does this fit here, or somewhere else?
--->
<p><em>what is ohicore and how does it operate with my ohi+ repo?</em></p>
<p><em><strong>ohicore</strong> is a package developed by our team that contains all the essential functions and supporting packages you will use to calculate the final OHI scores. By installing ohicore and calling it from your ohi+ assessment repository, you gain access to all those funcitons and packages. ohicore comes into play when you calculate overall goal scores.</em></p>
<p><em>How to install?: (this should be in a separate tutorial… eg. preparte your toolbox?) To install, open and source the script install_ohicore.r in your scenario folder (ie. your regionYEAR folder). This only needs to be done once at the beginning of your assessment, and you do not need to rerun it again during an assessment.</em></p>
</div>
<div id="substituting-new-data-layers" class="section level2">
<h2><span class="header-section-number">6.4</span> Substituting new data layers</h2>
<!---TODISCUSS: scope and TODO --->
<ul>
<li>and learning about functions</li>
</ul>
</div>
<div id="source-configure_toolbox.r" class="section level2">
<h2><span class="header-section-number">6.5</span> Source <code>configure_toolbox.r</code></h2>
<p>Now you have fully prepared and registered the data with the Toolbox, there is just one more step before calculations! We have to make sure everything is properly configured for the Toolbox:</p>
<div class="figure">
<img src="https://docs.google.com/drawings/d/1WvHfWe06D2x9cKB7vhWrmvmxuRpmGvzsMs9AjS23g3E/pub?h=450" />

</div>
<p>This script combines everything required to calculate OHI scores and checks that they are properly formatted, and will minimize potential errors down the line. It makes sure that your data and goal models are ready to be used to calculate scores. <strong>TODO <code>@ningningj</code>/<code>@jules32</code>: add section/language about how to interpret errors: errors are identifying YOUR problems, not ohicore’s (said in a nicer way)</strong> <code>@jules32</code>: see below under step 3.</p>
<p>Ning’s edits:</p>
<p>More specifically, sourcing <code>configure_toolbox.r</code> will:</p>
<ol style="list-style-type: decimal">
<li><p>load the necessary <code>R</code> packages, including <code>ohicore</code></p></li>
<li><p>load scenario configurations. TODO <code>@ningningj</code>: I think we need to write out what <code>ohicore::Conf('conf')</code> etc are doing, this is too vague; Ning’s edits: This step links together all the data layers (for goal, pressures, resilience), goal functions, and other OHI parameters that determines how ohi scores are calculated <code>@jules32</code>: I also added this language to configure_toolbox.R directly. since people will follow along in that script.</p></li>
<li><p>check that data layers are properly formatted and registered</p></li>
</ol>
<p>Ning’s edits: This is a gate-keeping step by ohicore to make sure the data layers you’ve entered are in the right format and can be read by ohicore properly. You’ll likely encounter error messages. These messages intend to alert you that there are errors in data entry. Some common errors are: - registration error. data layer name doesn’t match what’s been registered under “file name” in layers.R - missing comuns (eg. region id) …?</p>
<ol start="4" style="list-style-type: decimal">
<li>load data layers so that you can call them in functions.r</li>
</ol>
<p><em><strong>Note</strong>: repeat this step whenever you save a new data layer or change a goal function.</em> **TODO <code>@ningningj</code>: this is a really important point, should not be a note but a statement, and probably in the bigger overview above;</p>
<p><em><strong>Tip</strong>: “Source” to run all the lines</em></p>
<div class="figure">
<img src="https://docs.google.com/drawings/d/1JvSJKyiwvp92--obTwHT3IYht1XE0823sORJ4FdnX74/pub?h=450" />

</div>
<div id="explore-goal-model" class="section level3">
<h3><span class="header-section-number">6.5.1</span> Explore goal model</h3>
<p>Now you are ready to examine the goal model in <code>functions.r</code> and confirm that your data layer is appropriately called. <code>functions.r</code> is in the <code>conf</code> folder. TODO <code>@ningningj</code>/<code>@jules32</code>: more here</p>
<div class="figure">
<img src="https://docs.google.com/drawings/d/1CKNjIORLJOEaV2XW4Z9QuFLN7q1lJ1PaEGg2dSG1-_o/pub?h=450" />

</div>
<p>Open <code>functions.r</code>, go to the appropriate goal function. We will use Artisanal Fishing Opportunity (AO) as an example.</p>
<p><em><strong>Tip</strong>: Clicking the bottom left corner of Console will show you a drop-down menu of all functions. It’s a shortcut to jump to the appropriate section or goal model.</em></p>
<div class="figure">
<img src="https://docs.google.com/drawings/d/1Z2AVtVfIZEd_5GDcmaLb8mRpErKTDzmcbg0SBMxKsxs/pub?h=450" />

</div>
<p><strong>TODO <code>@ningningj</code>: see note above but this needs to be more prominent</strong></p>
<p>TODO <code>@ningningj</code>/<code>@jules32</code>: develop paragraphs from these bullets:</p>
<p>Ning’s edits:</p>
<p><code>functions.r</code> has goal models for each goal in the assessment. <strong>Each goal model is an individual R function that calculates status and trend, and you will modify the goal model within the confines of each function</strong>. Each function contains these steps: load data layers, calculate status, calculate trend, combine status and trend. Destails of each step is further explained below.</p>
<p><em><code>functions.r</code> in your Full Repo are populated with <code>R</code> code from the most recent OHI global assessment as a starting place. You can run through the reference script line-by-line to learn how it has been done. Now we’ll use Artisanal Fishing Opportunity goal as an example.</em></p>
</div>
<div id="selectlayersdata" class="section level3">
<h3><span class="header-section-number">6.5.2</span> SelectLayersData</h3>
<p>Run this chunk of code and the data layers will be loaded, joined, and ready to be manipulated further:</p>
<p><strong>TODO <code>@ningningj</code>/<code>@jules32</code>: SelectLayersData is from ohicore, what it’s doing…</strong> <code>@jules32</code>: See inline comments. I updated them in functions.r in demo repo too. might be easier to follow there.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## &quot;SelectLayersData&quot; is an ohicore funtion to call the appropriate data layer by its layer name registered in`layers.csv` (eg. &quot;ao_access&quot;)

## &quot;select&quot;&quot; is a function from the dplyr package to let you select only the columns you would need

r &lt;-<span class="st"> </span><span class="kw">SelectLayersData</span>(layers, <span class="dt">layers =</span> <span class="st">&#39;ao_access&#39;</span>, <span class="dt">narrow=</span><span class="ot">TRUE</span>) %&gt;%
<span class="st">    </span><span class="kw">select</span>(<span class="dt">region_id=</span>id_num, <span class="dt">access=</span>val_num)
r &lt;-<span class="st"> </span><span class="kw">na.omit</span>(r)

ry &lt;-<span class="st"> </span><span class="kw">SelectLayersData</span>(layers, <span class="dt">layers =</span> <span class="st">&#39;ao_need&#39;</span>, <span class="dt">narrow=</span><span class="ot">TRUE</span>) %&gt;%
<span class="st">    </span><span class="kw">select</span>(<span class="dt">region_id =</span> id_num, year, <span class="dt">need=</span>val_num) %&gt;%
<span class="st">    </span><span class="kw">left_join</span>(r, <span class="dt">by=</span><span class="st">&quot;region_id&quot;</span>)</code></pre></div>
<blockquote>
<p>Tip: it’s always a good idea to check what your data looks like and make sure there are no glaring errors. A couple of commonly used functions are: head() and str()</p>
</blockquote>
</div>
<div id="calculate-status" class="section level3">
<h3><span class="header-section-number">6.5.3</span> Calculate status</h3>
<p>Once you make sure your raw data have been loaded and joined in the right format, you can start calculate status scores!</p>
<p><strong>TODO <code>@ningningj</code>/<code>@jules32</code>: this syntax uses the <code>tidyverse</code> and chaining…look xxx to learn more</strong></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># model: this step calculates status scores of all years, using the goal model. </span>

## &quot;mutate&quot; is another commonly used function from dplyr that allows you to add a new column to the data frame
## Note that &quot;Sustainability&quot; and &quot;status_year&quot; have been defined at the start of the AO function 
  Sustainability=<span class="fl">1.0</span>
  status_year =<span class="st"> </span><span class="dv">2015</span>

  ry &lt;-<span class="st"> </span>ry %&gt;%
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">Du =</span> (<span class="dv">1</span> -<span class="st"> </span>need) *<span class="st"> </span>(<span class="dv">1</span> -<span class="st"> </span>access)) %&gt;%
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">status =</span> (<span class="dv">1</span> -<span class="st"> </span>Du) *<span class="st"> </span>Sustainability)

<span class="co"># status: status scores are typically the most recent year of all the years you have calculated. </span>

  r.status &lt;-<span class="st"> </span>ry %&gt;%
<span class="st">    </span><span class="kw">filter</span>(year==status_year) %&gt;%
<span class="st">    </span><span class="kw">select</span>(region_id, status) %&gt;%
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">status=</span>status*<span class="dv">100</span>)</code></pre></div>
</div>
<div id="calculate-trend" class="section level3">
<h3><span class="header-section-number">6.5.4</span> Calculate trend</h3>
<p>Trend scores are typically based on linear regression of status scores from the most recent five years.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"> <span class="co"># choose trend years (eg. most recent five years)</span>

  trend_years &lt;-<span class="st"> </span>(status_year<span class="dv">-4</span>):(status_year)
  adj_trend_year &lt;-<span class="st"> </span><span class="kw">min</span>(trend_years)

  r.trend =<span class="st"> </span>ry %&gt;%
<span class="st">    </span><span class="kw">group_by</span>(region_id) %&gt;%<span class="st"> </span>
<span class="st">    </span><span class="co"># linear model: </span>
<span class="st">    </span><span class="kw">do</span>(<span class="dt">mdl =</span> <span class="kw">lm</span>(status ~<span class="st"> </span>year, <span class="dt">data=</span>., <span class="dt">subset=</span>year %in%<span class="st"> </span>trend_years),
       <span class="dt">adjust_trend =</span> .$status[.$year ==<span class="st"> </span>adj_trend_year]) %&gt;%
<span class="st">    </span><span class="co"># extract the coefficient of year and produce a trend score</span>
<span class="st">    </span><span class="kw">summarize</span>(region_id, <span class="dt">trend =</span> <span class="kw">ifelse</span>(<span class="kw">coef</span>(mdl)[<span class="st">&#39;year&#39;</span>]==<span class="dv">0</span>, <span class="dv">0</span>, <span class="kw">coef</span>(mdl)[<span class="st">&#39;year&#39;</span>]/adjust_trend *<span class="st"> </span><span class="dv">5</span>)) %&gt;%
<span class="st">    </span><span class="co"># make sure that the scores are between -1 and 1</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">trend =</span> <span class="kw">ifelse</span>(trend&gt;<span class="dv">1</span>, <span class="dv">1</span>, trend)) %&gt;%
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">trend =</span> <span class="kw">ifelse</span>(trend&lt;(-<span class="dv">1</span>), (-<span class="dv">1</span>), trend)) %&gt;%
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">trend =</span> <span class="kw">round</span>(trend, <span class="dv">4</span>))</code></pre></div>
</div>
<div id="combine-status-and-trend-scores" class="section level3">
<h3><span class="header-section-number">6.5.5</span> Combine status and trend scores</h3>
<p>Choose only region_id and score, and add two more columns identifying score dimension (status or trend) and goal name.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"> scores =<span class="st"> </span>r.status %&gt;%
<span class="st">    </span><span class="kw">select</span>(region_id, <span class="dt">score=</span>status) %&gt;%
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">dimension=</span><span class="st">&#39;status&#39;</span>) %&gt;%
<span class="st">    </span><span class="kw">rbind</span>(
      r.trend %&gt;%
<span class="st">        </span><span class="kw">select</span>(region_id, <span class="dt">score=</span>trend) %&gt;%
<span class="st">        </span><span class="kw">mutate</span>(<span class="dt">dimension=</span><span class="st">&#39;trend&#39;</span>)) %&gt;%
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">goal=</span><span class="st">&#39;AO&#39;</span>)</code></pre></div>
</div>
</div>
<div id="developing-goal-models" class="section level2">
<h2><span class="header-section-number">6.6</span> Developing goal models</h2>
<ul>
<li>and adding new data layers</li>
<li>workflow with <code>configure_toolbox.r</code></li>
</ul>
<div id="update-goal-call-in-goals.csv" class="section level3">
<h3><span class="header-section-number">6.6.1</span> Update goal call in <code>goals.csv</code>**</h3>
<!---TODISCUSS: maybe this detail should go somewhere else and then just referenced here? Because will also need this information referenced in the ## Removing Goals and ## Changing Subgoals sections --->
<p><code>goals.csv</code> in the <code>conf</code> folder provides input information for <code>functions.r</code>, particularly about function calls. These are indicated by two columns: <em>preindex_function</em> (functions for all goals that do not have sub-goals, and functions for all sub-goals) and <em>postindex_function</em> (functions for goals with sub-goals).</p>
<p>In the <code>preindex_fuction</code>, you could specify variables such as <em>status_year</em> and <em>trend_year</em>, which you can call in your goal function. Note that it is not necessary to specify those variables. If you do not use them in your function as in the CS example, you could delete those variables in <code>preindex_function</code>.</p>
<p><em>Changing goal weights will be done here by editing the value in the <em>weight</em> column. Weights do not need to be 0-1 or add up to 10; weights will be scaled as a proportion of the number of goals assessed. The ten goals are weighted equally by default.</em></p>
<div class="figure">
<img src="https://docs.google.com/drawings/d/17BgYSw2sHbZvHNjUqBlTG-kCOAAn7o6a65O37s0S_es/pub?h=500" />

</div>
<div class="figure">
<img src="https://docs.google.com/drawings/d/1o2wtJ9KCPDyGPH9Y4unmALG6BlxX9lmJ_PakDDiQrLo/pub?h=500" />

</div>
</div>
</div>
<div id="removing-goals" class="section level2">
<h2><span class="header-section-number">6.7</span> Removing goals</h2>
</div>
<div id="changing-subgoals" class="section level2">
<h2><span class="header-section-number">6.8</span> Changing subgoals</h2>
<p>(these last 2 may be better in a different chapter really).</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="preparing-data.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="updating-your-website.html" class="navigation navigation-next " aria-label="Next page""><i class="fa fa-angle-right"></i></a>

<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
