# Brainstorm 

THIS IS NOT A CHAPTER, but for meeting w/ `@ningningj`, `@jules32` 2/15

## Overview

This is a 2-hour hands-on training. All training materials are below, and can also serve as a self-paced workshop without in-person instruction. 

### Prerequisites

Before you begin, do the following: 

1. Make sure you have RStudio and GitHub setup (Chapter \@ref(workflow)), with an up-to-date version of R and RStudio
1. Fork the [**toolbox-demo**](https://github.com/OHI-Science/toolbox-demo) repository into your own GitHub account (click Fork in the upper right corner, and select your account)
1. Clone the **toolbox-demo** repo from your GitHub account into RStudio (Chapter X)
1. Get comfortable: be set up in a way so that you can see this tutorial and your RStudio window (maybe 2 screens, maybe switching between programs). 

## Remind yourself of the Toolbox file ecosystem

Chapter \@ref(toolbox-ecosystem)

In the **toolbox-demo** repo, we have a scenario folder called **region2016**.

## `calculate_scores.r` workflow

`calculate_scores.r` is a script that you'll run a lot - in its entirety and piece-by-piece. It will load the libraries you need, check your book keeping and configure everything for `ohicore`, calculate OHI scores by calculating the required dimensions in a specific order (see below) and ultimately save scores for each goal and dimension in `scores.csv`. <!---TODO: add figure-generation back in?--->

> OHI 'dimensions' are status, trend, pressures, resilience, likely future state, and scores, and are calculated for each goal. 

follow along, we're doing this together...


### run `install_ohicore.r`

TODO: explanation of what's happening, potential errors (eg not have devtools installed, typos...)

### region2016/calculate_scores.r

Open `calculate_scores.r` by navigating to it in the `region2016` folder and clicking on it. 

- comments up top to help explain 

- run line-by-line, explain warning messages. The order that CalculateAll() operates: YOUR goal models (status + trend) in functions.r, pressures and resilience based on YOUR matrix tables, Likely Future State and Scores (combo of the above)

```{r, eval=FALSE}
## run the configure_toolbox.r script to check configuration
source('~/github/toolbox-demo/region2016/configure_toolbox.r')

# ...
#   tr_travelwarnings
# Warning messages:
# 1: In ohicore::CheckLayers("layers.csv", "layers", flds_id = conf$config$layers_id_fields) :
#   Unused fields...
#     ico_spp_iucn_status: iucn_sid
# 2: In ohicore::CheckLayers("layers.csv", "layers", flds_id = conf$config$layers_id_fields) :
#   Rows duplicated...
#     ico_spp_iucn_status: 816

```

```{r, eval=FALSE}

## calculate scenario scores
scores = ohicore::CalculateAll(conf, layers)

# Running Setup()...
# Calculating Status and Trend for each region for FIS...
# Calculating Status and Trend for each region for MAR...
# 95th percentile for MAR ref pt is: 0.0758396517531756
# ...
# Calculating Pressures for each region...
# There are 6 pressures subcategories: pollution, alien_species, habitat_destruction, fishing_pressure, climate_change, social 
# These goal-elements are in the weighting data layers, but not included in the pressure_matrix.csv:
# LIV-aqf
# These goal-elements are in the pressure_matrix.csv, but not included in the weighting data layers:
# CP-coral, CP-mangrove, CP-saltmarsh, CS-mangrove, CS-saltmarsh, HAB-coral, HAB-mangrove, HAB-saltmarsh, HAB-seagrass, LIV-ph, LIV-tran, CP-seaice_shoreline, HAB-seaice_edge, ECO-wte, LIV-wte, LIV-sb
# Calculating Resilience for each region...
# There are 7 Resilience subcategories: ecological, alien_species, goal, fishing_pressure, habitat_destruction, pollution, social 
# These goal-elements are in the resilience_matrix.csv, but not included in the weighting data layers:
# CP-coral, CP-saltmarsh, CS-saltmarsh, HAB-coral, HAB-saltmarsh, HAB-seagrass, CP-mangrove, CS-mangrove, HAB-mangrove, HAB-seaice_edge, CP-seaice_shoreline
# ...
# Calculating Goal Score and Likely Future for each region for FIS...
# Calculating Goal Score and Likely Future for each region for MAR...
# ...Calculating post-Index function for each region for FP...
# Calculating post-Index function for each region for LE...
# Calculating Index score for each region for supragoals using goal weights...
# Calculating Likely Future State for each region for supragoals using goal weights...
# Calculating Post-process PreGlobalScores() function for each region...
# Calculating scores for ASSESSMENT AREA (region_id=0) by area weighting...
# Calculating FinalizeScores function...
```

And the warning messages: 

```
Warning messages:
1: In left_join_impl(x, y, by$x, by$y, suffix$x, suffix$y) :
  joining factors with different levels, coercing to character vector
2: In left_join_impl(x, y, by$x, by$y, suffix$x, suffix$y) :
  joining factor and character vector, coercing into character vector
3: In left_join_impl(x, y, by$x, by$y, suffix$x, suffix$y) :
  joining factors with different levels, coercing to character vector
4: In left_join_impl(x, y, by$x, by$y, suffix$x, suffix$y) :
  joining factor and character vector, coercing into character vector
5: In min(d$x, na.rm = T) : no non-missing arguments to min; returning Inf
6: In max(d$x, na.rm = T) :
  no non-missing arguments to max; returning -Inf
7: In min(d$x, na.rm = T) : no non-missing arguments to min; returning Inf
8: In max(d$x, na.rm = T) :
  no non-missing arguments to max; returning -Inf
```

### Recap of what just happened

## Update a data layer and let's see the whole process again. 

### update data layer but with the same layer name

TODO: add layer in demo/ folder and have them move it to layers/ and register it too, briefly.  

### rerun calculate_scores.r 

- see that now `scores.csv` shows up in the git window. Great way to check your work. Which goal do you expect to change?

So now let's take a closer look, let's check out configure_toolbox.r, the first thing that runs. 

## configure_toolbox.r

What does it do? 

### loads libraries
(also, if you are requiring other libraries, this would be the place to put them)

### `ohicore::Conf()`
```{r, eval=FALSE}
## load scenario configuration
conf = ohicore::Conf('conf')

# (no output). 
```

TODO: Explain

### `ohicore::CheckLayers()`

It lists all of the layers that are registered. Check to make sure ours is there. 

```{r, eval=FALSE}
## check that scenario layers files in the \layers folder match layers.csv registration. Layers files are not modified.
ohicore::CheckLayers('layers.csv', 'layers', flds_id=conf$config$layers_id_fields)
```

Warning messages alert you to problems with specific layers. eg duplicates in a status layer. Byproduct of the repo creation; you'll be changing this layer anyways. 
```
Warning messages:
1: In ohicore::CheckLayers("layers.csv", "layers", flds_id = conf$config$layers_id_fields) :
  Unused fields...
    ico_spp_iucn_status: iucn_sid
2: In ohicore::CheckLayers("layers.csv", "layers", flds_id = conf$config$layers_id_fields) :
  Rows duplicated...
    ico_spp_iucn_status: 816
```

### `ohicore::Layers()`

TODO: explain
```{r, eval=FALSE}
## load scenario layers for ohicore to access. Layers files are not modified.
layers = ohicore::Layers('layers.csv', 'layers')

# (no output)

```

## `functions.r`

Remember from `calculate_scores.r` that after configure_toolbox, the next thing that happens is that CalculateScores() runs through the goal models and calcuates status and trend. Let's look line-by-line at one of those goal models. We'll do it for the goal whose layer we changed. 

## TODISCUSS

If you were to add a new data layer and/or change the goal model... (?) how far can we get into that from here?

## TODISCUSS

- I deleted the figure-making in calculate_scores.r for now
