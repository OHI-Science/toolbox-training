# OHI workflow {#ohi-workflow} 

## Overview

This is a 2-hour hands-on training. All training materials are below, and can also serve as a self-paced workshop without in-person instruction. 

TODO `@jules32`: This chapter will take you from prepared data to calculated scores. It requires book keeping, `R` functions, and ultimately, the `R` package `ohicore`... In this chapter we're going to 
    - single goal model with updated data, basically line-by-line to understand the architecture of goal models (access the correct data layers, calc status, calc trend, make sure the final output is standard for what the `scores variables` need. 
    - then calculate all goal models and scores, including pressures, and resilience. 
    - introduce which data layer we modified and which goal model we are using as an example AO
    - a lot of shuffling and bookkeeping. 
    - runs the status, trend in functions.r, but also calculates pressures, resilience, lfs, and overall scores. 
    - score.csv updated, check that in Git tab of RStudio

### Prerequisites

Before you begin, do the following: 

1. Make sure you have RStudio and GitHub setup (Chapter \@ref(workflow)), with an up-to-date version of R and RStudio
1. Fork the [**toolbox-demo**](https://github.com/OHI-Science/toolbox-demo) repository into your own GitHub account (click Fork in the upper right corner, and select your account)
1. Clone the **toolbox-demo** repo from your GitHub account into RStudio (Chapter X)
1. Get comfortable: be set up in a way so that you can see this tutorial and your RStudio window (maybe 2 screens, maybe switching between programs). 

## Remind yourself of the Toolbox file ecosystem

Chapter \@ref(toolbox-ecosystem)

In the **toolbox-demo** repo, we have a scenario folder called **region2016**.

TODO: will probably need a section "what is ohicore and how does it operate with my ohi+ repo?" 


## Calculating scores with `calculate_scores.r`

`calculate_scores.r` is a script that you'll run a lot - in its entirety and piece-by-piece. It will load the libraries you need, check your book keeping and configure everything for `ohicore`, calculate OHI scores by calculating the required dimensions in a specific order (see below) and ultimately save scores for each goal and dimension in `scores.csv`.

> OHI 'dimensions' are status, trend, pressures, resilience, likely future state, and scores, and are calculated for each goal. 

follow along, we're doing this together...

![](https://docs.google.com/drawings/d/1uMcbzmBRgjxKVgRqLYnxpbOGIJrm1AbMw7D3E-dUFzk/pub?w=960&h=720)


### run `install_ohicore.r`

`ohicore` is an R package developed by the OHI team that has all the essential functions and supporting packages you will use to develop your assessment and calculate scores. By installing `ohicore` and calling it from the `toolbox-training` repository, you gain access to all those functions and packages. Learn more about `ohicore` in Chapter X.  

### region2016/calculate_scores.r

TODO: 
Open `calculate_scores.r` by navigating to it in the `region2016` folder and clicking on it. 

- comments up top to help explain 
- requires ohicore.

- run line-by-line, explain warning messages. The order that CalculateAll() operates: YOUR goal models (status + trend) in functions.r, pressures and resilience based on YOUR matrix tables, Likely Future State and Scores (combo of the above)

```{r, eval=FALSE}
## run the configure_toolbox.r script to check configuration
source('~/github/toolbox-demo/region2016/configure_toolbox.r')

# ...
#   tr_travelwarnings
# Warning messages:
# 1: In ohicore::CheckLayers("layers.csv", "layers", flds_id = conf$config$layers_id_fields) :
#   Unused fields...
#     ico_spp_iucn_status: iucn_sid
# 2: In ohicore::CheckLayers("layers.csv", "layers", flds_id = conf$config$layers_id_fields) :
#   Rows duplicated...
#     ico_spp_iucn_status: 816

```

```{r, eval=FALSE}

## calculate scenario scores
scores = ohicore::CalculateAll(conf, layers)

# Running Setup()...
# Calculating Status and Trend for each region for FIS...
# Calculating Status and Trend for each region for MAR...
# 95th percentile for MAR ref pt is: 0.0758396517531756
# ...
# Calculating Pressures for each region...
# There are 6 pressures subcategories: pollution, alien_species, habitat_destruction, fishing_pressure, climate_change, social 
# These goal-elements are in the weighting data layers, but not included in the pressure_matrix.csv:
# LIV-aqf
# These goal-elements are in the pressure_matrix.csv, but not included in the weighting data layers:
# CP-coral, CP-mangrove, CP-saltmarsh, CS-mangrove, CS-saltmarsh, HAB-coral, HAB-mangrove, HAB-saltmarsh, HAB-seagrass, LIV-ph, LIV-tran, CP-seaice_shoreline, HAB-seaice_edge, ECO-wte, LIV-wte, LIV-sb
# Calculating Resilience for each region...
# There are 7 Resilience subcategories: ecological, alien_species, goal, fishing_pressure, habitat_destruction, pollution, social 
# These goal-elements are in the resilience_matrix.csv, but not included in the weighting data layers:
# CP-coral, CP-saltmarsh, CS-saltmarsh, HAB-coral, HAB-saltmarsh, HAB-seagrass, CP-mangrove, CS-mangrove, HAB-mangrove, HAB-seaice_edge, CP-seaice_shoreline
# ...
# Calculating Goal Score and Likely Future for each region for FIS...
# Calculating Goal Score and Likely Future for each region for MAR...
# ...Calculating post-Index function for each region for FP...
# Calculating post-Index function for each region for LE...
# Calculating Index score for each region for supragoals using goal weights...
# Calculating Likely Future State for each region for supragoals using goal weights...
# Calculating Post-process PreGlobalScores() function for each region...
# Calculating scores for ASSESSMENT AREA (region_id=0) by area weighting...
# Calculating FinalizeScores function...
```

And the warning messages: 

```
Warning messages:
1: In left_join_impl(x, y, by$x, by$y, suffix$x, suffix$y) :
  joining factors with different levels, coercing to character vector
2: In left_join_impl(x, y, by$x, by$y, suffix$x, suffix$y) :
  joining factor and character vector, coercing into character vector
3: In left_join_impl(x, y, by$x, by$y, suffix$x, suffix$y) :
  joining factors with different levels, coercing to character vector
4: In left_join_impl(x, y, by$x, by$y, suffix$x, suffix$y) :
  joining factor and character vector, coercing into character vector
5: In min(d$x, na.rm = T) : no non-missing arguments to min; returning Inf
6: In max(d$x, na.rm = T) :
  no non-missing arguments to max; returning -Inf
7: In min(d$x, na.rm = T) : no non-missing arguments to min; returning Inf
8: In max(d$x, na.rm = T) :
  no non-missing arguments to max; returning -Inf
```

### Recap of what just happened

TODO `jules32`: add text here

Hopefully this first time you haven't encountered error messages, but you definitely will as you move ahead. Error messages are often due to typos or operations you are carrying out in `R`. Error messages often try to alert you to what went wrong, and we are continually improving error messages you'll encounter when you use `ohicore` so you can try to solve them. Some commonly occurring errors and how to fix them can be found in the Troubleshooting section of the manual. Copy-pasting error messages into Google is also a great aproach. 


## Update a data layer and let's see the whole process again. 

TODO `@jules32`: In this example, we will substitute a single global data layer with local data and recalculate scores without modifying the goal model itself. The \@ref(update) chapter will show an example for updating goal models. 

### update data layer but with the same layer name

TODO: and register it too, briefly.  

- make a fake Prep.r. last step: save in layers folder
Ning: anything we show here should be what they would do. Look at Ning's tutorials/data prep 

### rerun calculate_scores.r 

- see that now `scores.csv` shows up in the git window. Great way to check your work. Which goal do you expect to change?
- and layers.csv, and your layers file

**Checking your work:** Whenever there are changes made (addition, deletion, changes in .csv or r script), you will be notified in the Git window, since Git is tracking changes to your work. So here, since you added a new data layer, and also expect changes to AO scores in `score.csv`. This is a good place to double check whether you have made the right changes.

## `configure_toolbox.r`

So now let's take a closer look, let's check out configure_toolbox.r, the first thing that runs. 

`configure_toolbox.r` combines everything required to calculate OHI scores and checks that they are properly formatted, and will minimize potential errors later on. It makes sure that your data and goal models are ready to be used to calculate scores. 

![](https://docs.google.com/drawings/d/1WvHfWe06D2x9cKB7vhWrmvmxuRpmGvzsMs9AjS23g3E/pub?h=450)

> Any time you make a change to a data layer or a goal model and want to recalculate scores, you will need to re-run `configure_toolbox.r` to have ohicore operate on the most up-to-date information. You can click "Source" to run all the lines:

> ![](https://docs.google.com/drawings/d/1JvSJKyiwvp92--obTwHT3IYht1XE0823sORJ4FdnX74/pub?h=450)


### loads libraries

TODO: write
(also, if you are requiring other libraries, this would be the place to put them)

### `ohicore::Conf()`

This step links together all the data layers (for goal, pressures, resilience), goal functions, and other OHI parameters that determines how ohi scores are calculated. TODO: more 

```{r, eval=FALSE}
## load scenario configuration
conf = ohicore::Conf('conf')

# (no output). 
```


### `ohicore::CheckLayers()`

This function checks that data layers are properly formatted and registered, and returns a list of all of the layers that are registered. Check to make sure ours is there. This is a gate-keeping step by to make sure the data layers you've entered are in the right format and can be read by `ohicore` properly. 

```{r, eval=FALSE}
## check that scenario layers files in the \layers folder match layers.csv registration. Layers files are not modified.
ohicore::CheckLayers('layers.csv', 'layers', flds_id=conf$config$layers_id_fields)
```

Warning messages alert you to problems with specific layers: this is showing that there are duplicates in a status layer. These warning messages are not  a problem now (they are a byproduct of extracting this repo based on Global OHI assessments; you'll be changing this layer anyways). 

```
Warning messages:
1: In ohicore::CheckLayers("layers.csv", "layers", flds_id = conf$config$layers_id_fields) :
  Unused fields...
    ico_spp_iucn_status: iucn_sid
2: In ohicore::CheckLayers("layers.csv", "layers", flds_id = conf$config$layers_id_fields) :
  Rows duplicated...
    ico_spp_iucn_status: 816
```

You'll also encounter error messages as you develop your own assessment. These messages intend to alert you that there are errors in data entry. Some common errors are: 

- improper formatting or missing columns in your data layer
- typos or misnamed columns


### `ohicore::Layers()`

TODO: explain
```{r, eval=FALSE}
## load scenario layers for ohicore to access. Layers files are not modified.
layers = ohicore::Layers('layers.csv', 'layers')

# (no output)

```

## Explore a goal model in `functions.r`

TODO `@ningningj`: (I've moved this over here but make sure it still makes sense):

![](https://docs.google.com/drawings/d/1CKNjIORLJOEaV2XW4Z9QuFLN7q1lJ1PaEGg2dSG1-_o/pub?h=450)

Remember from `calculate_scores.r` that after configure_toolbox, the next thing that happens is that CalculateScores() runs through the goal models and calcuates status and trend. 

Open `functions.r`. `functions.r` is a big list of all goal models in the assessment, each as its own `R` function. You can run all of them at the once or each individually. **Each goal model is an individual R function that calculates status and trend, and you will modify the goal model within the confines of each function**. Let's look at the goal models for Artisanal Fishing Opportunity (AO) as an example. It has models developed from the most recent global assessment as a place for you to start.

> **Tip**: Clicking the bottom left corner of Console will show you a drop-down menu of all functions. It's a shortcut to jump to the appropriate section or goal model

 > ![](https://docs.google.com/drawings/d/1Z2AVtVfIZEd_5GDcmaLb8mRpErKTDzmcbg0SBMxKsxs/pub?h=450)

The following things happen in each goal model:
  
  - load specific data layers (using `ohicore::SelectLayersData()`) 
  - calculate status scores 
  - calculate trend scores 
  - combine status and trend scores 
  - format and return the `scores`


### Load specific data layers with `SelectLayersData()`

`SelectLayersData()` is an `ohicore` function to call the appropriate data layers by its layer name registered in `layers.csv` (eg. "ao_access")
Run this chunk of code and the data layers will be loaded, joined, and ready to be manipulated further: 

```{r load data, eval=FALSE}

## "select"" is a function from the dplyr package to let you select only the columns you would need

r <- SelectLayersData(layers, layers = 'ao_access', narrow=TRUE) %>%
    select(region_id=id_num, access=val_num)
r <- na.omit(r)

ry <- SelectLayersData(layers, layers = 'ao_need', narrow=TRUE) %>%
    select(region_id = id_num, year, need=val_num) %>%
    left_join(r, by="region_id")

```


> Tip: it's always a good idea to check what your data looks like and make sure there are no glaring errors. A couple of commonly used functions are: head() and str()

### Calculate status 

Once you make sure your raw data have been loaded and joined in the right format, you can start calculate status scores!

**TODO `@ningningj`/`@jules32`: this syntax uses the `tidyverse` and chaining...look xxx to learn more** 

```{r, eval=FALSE}
# model: this step calculates status scores of all years, using the goal model. 

## "mutate" is another commonly used function from dplyr that allows you to add a new column to the data frame
## Note that "Sustainability" and "status_year" have been defined at the start of the AO function 
  Sustainability=1.0
  status_year = 2015

  ry <- ry %>%
    mutate(Du = (1 - need) * (1 - access)) %>%
    mutate(status = (1 - Du) * Sustainability)

# status: status scores are typically the most recent year of all the years you have calculated. 

  r.status <- ry %>%
    filter(year==status_year) %>%
    select(region_id, status) %>%
    mutate(status=status*100)
```

### Calculate trend 

Trend scores are typically based on linear regression of status scores from the most recent five years. 

```{r, eval=FALSE}
 # choose trend years (eg. most recent five years)

  trend_years <- (status_year-4):(status_year)
  adj_trend_year <- min(trend_years)

  r.trend = ry %>%
    group_by(region_id) %>% 
    # linear model: 
    do(mdl = lm(status ~ year, data=., subset=year %in% trend_years),
       adjust_trend = .$status[.$year == adj_trend_year]) %>%
    # extract the coefficient of year and produce a trend score
    summarize(region_id, trend = ifelse(coef(mdl)['year']==0, 0, coef(mdl)['year']/adjust_trend * 5)) %>%
    # make sure that the scores are between -1 and 1
    mutate(trend = ifelse(trend>1, 1, trend)) %>%
    mutate(trend = ifelse(trend<(-1), (-1), trend)) %>%
    mutate(trend = round(trend, 4))

```

### Combine status and trend scores 

Choose only region_id and score, and add two more columns identifying score dimension (status or trend) and goal name. 
```{r, eval=FALSE}
 scores = r.status %>%
    select(region_id, score=status) %>%
    mutate(dimension='status') %>%
    rbind(
      r.trend %>%
        select(region_id, score=trend) %>%
        mutate(dimension='trend')) %>%
    mutate(goal='AO')
```





## Update goal model with the original data layers

TODO `@jules32`
 
## Update goal model by adding new layers
 
TODO `@jules32`

 - add a new row to layers.csv
 - use SelectLayersData() to access your new layer, and then use it in a calculation. 
 
 
 
end 2-hour tutorial.



## TODISCUSS ongoing list

- [this workflow figure](https://docs.google.com/drawings/d/1MAIgSAFUTFg2J9XKIYBUFttOfHex5OSMbXIDlUMlKSY/pub?h=500), do we need it anymore?
    - **TODO `@ningningj`: this figure may be more clear here if the red boxes are removed and instead placed around the green top pieces "modify goal models" and "calculate scores"?** `@jules32`: i didn't do that because we are not updating pressures and resilience. but your point is totally valid. i updated the figure as below, highlighting only the steps and scripts used here. what do you think?


<!---next step after Eva training: 

- PlotFlower, PlotMap
- updating pressures/resilience matrices


--->
