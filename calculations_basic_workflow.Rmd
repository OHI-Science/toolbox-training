# Calculations: basic workflow {#calcs-basic} 

The purpose of Chapter \@ref(calcs-basic) is to introduce you to the basic workflow for calculating OHI scores. This is a a 2-hour hands-on training: you will be following along on your own computer and working with a copy of the demonstration repository that is used throughout the this chapter.

## Overview

Calculating scores requires a tailored repository operating with the OHI `R` package `ohicore`. The tailored repo has information specific to your assessment — most importantly the data and goal models — and `ohicore` will combine these with OHI core operations to calculate scores. You will always start with a tailored repository that has data and models extracted from the most recent Global OHI assessment.

![](https://docs.google.com/drawings/d/1wGK68NRn5bmhZo_gC2A9sx-AcpIZHVp45ID5_HQKVJ0/pub?w=768&h=192)


This training will focus around the file in tailored repo called `calculate_scores.r. We will repeat the basic workflow to calculate scores, each time introducing more complexity through several variations: 

1. Calculate scores 'out of the box' using data and models extracted from the Global 2016 assessment
1. Calculate scores using a tailored data layer and the 'out of the box' model
1. Calculate scores using a tailored data layer and a tailored model

Along the way we'll also dive deeper into the code itself, focusing particularly on required configuration with `configure_toolbox.r` and developing goal models in `functions.r`. 

This is a lot to cover in a 2-hour training. But the Toolbox has a lot of moving parts, and we cannot cover all of it here. This training will give you big take home messages and experience for what you need to begin calculating scores. There are a lot of details and other operations that we won't get into here and that will be coming in future tutorials (including tailoring pressures & resilience, and how to change subgoals). 


### Prerequisites

Before the training, please make sure you have done the following: 

1. Make sure you have up-to-date versions of `R` and RStudio and have RStudio configured with Git/GitHub
    - https://cloud.r-project.org
    - http://www.rstudio.com/download 
    - http://happygitwithr.com/rstudio-git-github.html <!--- TODO (Chapter \@ref(datascience))--->
1. Fork the **toolbox-demo** repository into your own GitHub account by going to https://github.com/OHI-Science/toolbox-demo, clicking "Fork" in the upper right corner, and selecting your account
1. Clone the **toolbox-demo** repo from your GitHub account into RStudio into a folder called "github" in your home directory (filepath "~/github")
1. Get comfortable: be set up with two screens if possible. You will be following along in RStudio on your own computer while also watching an instructor's screen or following this tutorial.

----

## Review the Toolbox file ecosystem

<!--- TODO `@ningningj`: toolbox_ecosystem.rmd
TODO @jules32: once toolbox_ecosystem.rmd is done, move this Review section into the Prerequesites section--->

This was covered in Chapter \@ref(toolbox). In our **toolbox-demo** repo, we have a scenario folder called **region2016**. Remember that the ecosystem structure of any OHI assessment is the same, so as you learn to navigate through and calculate scores in the **toolbox-demo** repository you are also learning how to navigate through and calculate scores in any other OHI assessment repository — yours or anyone else's.

TODO: 17 regions

This figure highlights the files we will go through in this tutorial: 
![](https://docs.google.com/drawings/d/11QcBxrUNQnzuvJBLcJLMp0C7jFvZ-mz4vIj3OkvlxZ8/pub?h=500)

### Run `install_ohicore.r`

If you don't already have `ohicore` installed, let's do that now. `ohicore` is an R package developed by the OHI team that has all the essential core functions and supporting packages you will use to develop your assessment and calculate scores. You will install `ohicore` one time and then load its library from the `toolbox-training` repository whenever you work on your assessment to gain access to all those functions and packages. 

Let's open and source `install_ohicore.r`. Learn more about `ohicore` in Chapter X. <!---TODO:: where would a section on ohicore go? Maybe need to make a vingette for it and link to it but not have a section here.---> 


## Run `calculate_scores.r`

`calculate_scores.r` takes inputs (data and models) from the Toolbox and compute OHI scores, as the file name suggests. It has several components which we will explore in turn in the rest of  the tutorial. 
![](https://docs.google.com/drawings/d/1OhA7p5-dmrk6dGeP_gWEXFD2pI1ik8KhUYNUSLUVgd4/pub?w=960&h=720)

`calculate_scores.r` is also a script that you'll run a lot — both as a whole and piece-by-piece. It will load the libraries you need and `ohicore` will check your book-keeping and configuration, calculate OHI scores, and ultimately save the scores for each goal and dimension in `scores.csv`. The 'dimensions' of OHI goal scores are Status, Trend, Pressures, Resilience, Likely Future State, and overall goal Score. Dimensions are calculated for each goal in a specific order, as we will see below. `calculate_scores.r` will combine information from your tailored repository (your data layers, Status and Trend models, pressures and resilience matrices), and calculate scores with OHI core functions from `ohicore`. 

Open `calculate_scores.r` after navigating into the `region2016` folder. 

![](https://docs.google.com/drawings/d/1uMcbzmBRgjxKVgRqLYnxpbOGIJrm1AbMw7D3E-dUFzk/pub?w=960&h=720)


### Source `configure_toolbox.R`

We will start by **sourcing `configure_toolbox.R`**.
![](https://docs.google.com/drawings/d/1VRIZQFkbsDXNRtDQYBVyQIJvVkzP1POjKp8g8G3Ogg8/pub?h=450)

There is output printed to the console that lists all of the layers registered, and ends with any warning messages about the layers themselves. We will explore what is happening in `configure_toolbox.r` and how to interpret these warning messages further on; for now, let's move on since we have not encountered an error. 

```{r configure_toolbox, eval=FALSE}
## run the configure_toolbox.r script to check configuration
source('~/github/toolbox-demo/region2016/configure_toolbox.r')

#   cc_acid
#   cc_slr
# ...
#   tr_travelwarnings
# Warning messages:
# 1: In ohicore::CheckLayers("layers.csv", "layers", flds_id = conf$config$layers_id_fields) :
#   Unused fields...
#     ico_spp_iucn_status: iucn_sid
# 2: In ohicore::CheckLayers("layers.csv", "layers", flds_id = conf$config$layers_id_fields) :
#   Rows duplicated...
#     ico_spp_iucn_status: 816

```

### Run `CalculateAll()`

Now let's **run `CalculateAll()`** and discuss the output. Notice too that we are saving the output to a variable called `scores`.
![](https://docs.google.com/drawings/d/1mgmRwngXwVpoqBIlrQcRqKmKgSbGwAN79BD6p1zBwS4/pub?h=450)

> Note: the prefix `ohicore::` is a way to be explicit that the `CalculateAll()` is part of the `ohicore` package.

```{r CalculateAll, eval=FALSE}
## calculate scenario scores
scores = ohicore::CalculateAll(conf, layers)
```

`CalculateAll()` first calculates the Status and Trend for every goal and subgoal. These models are in your tailored repository's `functions.r` (we will explore `functions.r` below). You can choose to add messages to print during calculation like is shown below for Mariculture (MAR).

```{r CalculateAll_output_status, eval=FALSE}
# Running Setup()...
# Calculating Status and Trend for each region for FIS...
# Calculating Status and Trend for each region for MAR...
# 95th percentile for MAR ref pt is: 0.0758396517531756
# ... 
```

Next, we see output as `CalculateAll()` calculates Pressures and Resilience based on the pressures and resilience matrix tables in your tailored repository. For each, `ohicore` lists the subcategories that will be calculated, and identifies any mis-matches between data layers identified but not used or missing. We will learn more about the pressures and resilience matrices later on. <!---TODO: need to develop the pressures/resilience section---> 

```{r CalculateAll_output_pressures, eval=FALSE}
# Calculating Pressures for each region...

# There are 6 pressures subcategories: pollution, alien_species, habitat_destruction, fishing_pressure, climate_change, social
# These goal-elements are in the weighting data layers, but not included in the pressure_matrix.csv:
# LIV-aqf
# These goal-elements are in the pressure_matrix.csv, but not included in the weighting data layers:
# CP-coral, CP-mangrove, CP-saltmarsh, CS-mangrove, CS-saltmarsh, HAB-coral, HAB-mangrove, HAB-saltmarsh, HAB-seagrass, LIV-ph, LIV-tran, CP-seaice_shoreline, HAB-seaice_edge, ECO-wte, LIV-wte, LIV-sb


# Calculating Resilience for each region...

# There are 7 Resilience subcategories: ecological, alien_species, goal, fishing_pressure, habitat_destruction, pollution, social
# These goal-elements are in the resilience_matrix.csv, but not included in the weighting data layers:
# CP-coral, CP-saltmarsh, CS-saltmarsh, HAB-coral, HAB-saltmarsh, HAB-seagrass, CP-mangrove, CS-mangrove, HAB-mangrove, HAB-seaice_edge, CP-seaice_shoreline
```

Finally, we see output as `CalculateAll()` combines the dimensions above in several ways. It calculates the Goal Scores and Likely Future State for each goal and subgoal. Then, it calculates 'supragoals', which are goals that have subgoals, for example Food Provision (FP), which has the subgoals FIS (Wild-caught Fisheries) and Mariculture (MAR). Finally, it calculates the overall Index score for the entire Assessment Area using an area-weighted average. 

```{r CalculateAll_output_etc, eval=FALSE}
# ...
# Calculating Goal Score and Likely Future for each region for FIS...
# Calculating Goal Score and Likely Future for each region for MAR...
# ...
# Calculating post-Index function for each region for FP...
# Calculating post-Index function for each region for LE...
# Calculating Index score for each region for supragoals using goal weights...
# Calculating Likely Future State for each region for supragoals using goal weights...
# Calculating scores for ASSESSMENT AREA (region_id=0) by area weighting...
# Calculating FinalizeScores function...
```

Following all the calculations are the warning messages, which are due to operations within `functions.r`, which you will be able to fix as you tailor your goal models. These warning messages are due to using goal models from the global assessment with just a subset of data from the global assessment we have extracted here for the **toolbox-demo** repository.

```{r CalculateAll_output_warnings, eval=FALSE}
# Warning messages:
# 1: In left_join_impl(x, y, by$x, by$y, suffix$x, suffix$y) :
#   joining factors with different levels, coercing to character vector
# ...
# 8: In max(d$x, na.rm = T) :
#   no non-missing arguments to max; returning -Inf
```

### Save scores variable as `scores.csv`

Finally, we will save the output from `CalculateAll()`, a variable called `scores`, as a comma-separated-value file called `scores.csv`. 
![](https://docs.google.com/drawings/d/1A0FP2KnlHEJ5jCT5RwFJ9YtF5DhjTArHTGzn_JoJjXs/pub?h=450)

We can inspect it and see that it is a long-formatted file with four columns for the goal, dimension, numeric region identifier, and score. 

```{r write_scores, eval=FALSE}
## save scores as scores.csv
write.csv(scores, 'scores.csv', na='', row.names=F)
```

|goal |dimension | region_id| score|
|:----|:---------|---------:|-----:|
|AO   |future    |         0| 92.85|
|AO   |future    |         1| 92.85|
|AO   |future    |         2| 92.85|
|...  |...       |       ...|  ... |
|AO   |future    |        17| 92.85|
|AO   |pressures |         1| 37.75|
|AO   |pressures |         2| 37.75|
|...  |...       |       ...|  ... |

We have 17 regions in the **toolbox-demo** repo. An additional region 0 is the area-weighted combination of all regions.

> Note: each region in your assessment will have a numeric region identifer, called a `region_id` or `rgn_id` for short. You can see a list of all regions and corresponding identifiers in [toolbox-demo/region2016/spatial/regions_list.csv](https://github.com/OHI-Science/toolbox-demo/blob/master/region2016/spatial/regions_list.csv)


### A note about error messages

Hopefully this first time through `calculate_scores.r` you did not encounter error messages, but you definitely will as you move ahead. Error messages are often due to typos or miscommunications between what you tell `R` versus what it expects. You will encounter error messages due to `R` itself, and due to `ohicore`. Error messages often have human-friendly messages to alert you to what went wrong, and we are continually improving error messages you'll encounter when you use `ohicore` so you can try to solve them more easily. Some commonly occurring errors and how to fix them can be found in the Troubleshooting section of the manual. Copy-pasting error messages into Google is also one of the best places to start. 


### Recap of what just happened

We have just successfully run through the basic workflow to calculate OHI scores. We will build on this basic workflow, by exploring the operations above in more detail, and by updating the data, models, and configurations within the **toolbox-demo** repository. 

![](https://docs.google.com/drawings/d/1CnZ2qwQQzTjJuZ3P53FuQ4qhkBdq1xl6UuZnQmt2v80/pub?h=450)


## Tailor a data layer and rerun `calculate_scores.r`

In this example, we will prepare local data that will substitute Global OHI data for the data layer `ao_access` and recalculate scores without modifying the goal model itself.

![](https://docs.google.com/drawings/d/1kRwkY_vqAXh-nACsS39ZHEVYW_zsGSFiKs_-5W6swBs/pub?h=450)

It's always a good idea to Restart `R` before you begin something like this to make sure you don't have any variables loaded that will cause problems later on.

### Prepare and save our data layer

While Chapter \@ref(prep-data) shows in detail how to prepare data layers, save them in the "layers" folder, and register them so the Toolbox knows where to find them, we have prepared a shorter example with AO for our purposes here. 

Open `toolbox-demo/prep/AO/access_prep.R` and source it after reading it through. The result will be a new data layer saved to the "layers" folder, and you should see that there is a new file saved in your Git window. 

![](~/github/toolbox-training/figs/ao_access_demo_git.png)

### Register our data layer 

Now that we have prepared and saved our data layer, we'll register it in `layers.csv`. `layers.csv`is a registry that will direct `ohicore` to appropriate data layers, and has information about each data layer - which goal it is used for, filename, column names, etc. For further detail see Chapter \@ref(prep-data).

Since we have tailored an existing data layer that is already registered, we just need to have it point to our new data layer under the "filename" column. 

Open `region2016/layers.csv` in a spreadsheet software (i.e. Microsoft Excel or Open Office). Next, find "ao_access" in the "layer" column. The current filename it is associated with is "ao_access_gl2016.csv". Update that to say "ao_access_demo2017.csv" — the new data layer you just saved.

### Rerun `calculate_scores.r` 

Now, let's rerun `calculate_scores.r`. `ohicore` will now use your tailored data when it creates the "ao_access" layer because you've registered it in `layers.csv` and the file is available in the layers folder. 

**Checking your work:** Whenever there are changes made (addition, deletion, changes in .csv or r script), you will be notified in the Git window, since Git is tracking changes to your work. This is a good place to confirm you have did the things you set out to do, and you can also see if you errantly did anything you didn't mean to.

So here, since you added a new data layer, and also expect changes to AO scores in `score.csv`. `layers.csv` will also change because `ohicore` will update fields in this file as it runs through its checks. But we don't expect any other files to change at this point, so let's make sure that's true. 

TODO commit

### Recap of what just happened

One way to tailor your toolbox is to modify an existing data layer. We have just successfully substituted Global OHI data layer `ao_access` with new data, and rerun `calculate_scores.r` without modifying the goal model itself.

## Explore `configure_toolbox.r`

So now let's take a closer look at `configure_toolbox.r`, the first script that we run. 

![](https://docs.google.com/drawings/d/1oHMdrXNSeJ6l17aMUXihThYfb-HqvGviFrBYwJ2xldY/pub?h=450)

`configure_toolbox.r` combines everything required to calculate OHI scores and checks that they are properly formatted, and will minimize potential errors later on. It makes sure that your data and goal models are ready to be used to calculate scores. 

![](https://docs.google.com/drawings/d/1WvHfWe06D2x9cKB7vhWrmvmxuRpmGvzsMs9AjS23g3E/pub?h=450)

**Any time you make a change to a data layer or a goal model and want to recalculate scores, you will need to re-run `configure_toolbox.r` to have `ohicore` operate on the most up-to-date information**. You can click "Source" to run all the lines:

![](https://docs.google.com/drawings/d/1JvSJKyiwvp92--obTwHT3IYht1XE0823sORJ4FdnX74/pub?h=450)

It's also a good idea to go to RStudio's Session menu and select Restart R to make sure you have a clean working directory.

![](https://docs.google.com/drawings/d/1FmN6httmUUOcz1a1-2XjXxOnVWsZ8t68mVVGFSg7F1E/pub?w=960&h=432)

### Load libraries and set working directory

The first two things that `configure_toolbox.r` does is to set up your working environment. First, it loads `ohicore` and any `R` packages that will be needed as you work with `functions.r`: `tidyverse` (which includes `dplyr` and `tidyr`) and `stringr`. As you need other packages you can add them here to load. Second, it sets your working directory to your assessment's scenario: "region2016". 

```{r load ohicore and libraries, eval=FALSE}
## load ohicore and tidyverse
if (!"ohicore" %in% (.packages())) {
  suppressWarnings(require(ohicore))
  library(tidyverse)    # install.packages('tidyverse')
  library(stringr)
}

## set working directory to the scenario that contains conf and layers directories
setwd('~/github/toolbox-demo/region2016')
```

### `ohicore::Conf()`

Next, the `Conf()` function from `ohicore` prepares for the next steps of running the Toolbox, and calls forth everything you need to calculate scores: 

- all data layers (for goals, pressures, resilience) 
- goal functions, and 
- other OHI parameters that determines how OHI scores are calculated 


```{r Conf(), eval=FALSE}
## load scenario configuration
conf = ohicore::Conf('conf')
```


### `ohicore::CheckLayers()`

The `CheckLayers()` function from `ohicore` checks that data layers are properly formatted and registered (e.g., that each data layer in `layers.csv` is present in the layers folder), and returns a list of all of the layers that are registered. Check to make sure ours is there. This is a gate-keeping step by to make sure the data layers you've entered are in the right format and can be read by `ohicore` properly. 

```{r CheckLayers(), eval=FALSE}
## check that layers in the layers folder match layers.csv registration. 
ohicore::CheckLayers('layers.csv', 'layers', flds_id=conf$config$layers_id_fields)
```

#### Warning messages 

Warning messages alert you to problems with specific layers: this is showing that there are unused fields and duplicate rows. These warning messages are not  a problem now (they are a byproduct of extracting this repo based on Global OHI assessments; you'll be changing this layer anyways). 

```{r ohicore_warnings, eval=FALSE}
Warning messages:
1: In ohicore::CheckLayers("layers.csv", "layers", flds_id = conf$config$layers_id_fields) :
  Unused fields...
    ico_spp_iucn_status: iucn_sid
2: In ohicore::CheckLayers("layers.csv", "layers", flds_id = conf$config$layers_id_fields) :
  Rows duplicated...
    ico_spp_iucn_status: 816
```

You will encounter error messages as you develop your own assessment. These messages intend to alert you that there are errors in data entry. Some common errors are: 

- improper formatting or missing columns in your data layer
- typos or misnamed columns

<!---TODO this section could be more fleshed out--->

### `ohicore::Layers()`

The final operation in `configure_toolbox.r` is the `Layers()` function from `ohicore`, which combines all the information from the layers files and `layers.csv` into a single `R` object. This object will be used in `functions.r`.

<!---TODO Individual layers can be accessed as: layers$data$layer_name??? 
Note: `@jules32`: describe this vs. SelectLayersData() --->

```{r Layers(), eval=FALSE}
## load scenario layers for ohicore to access.
layers = ohicore::Layers('layers.csv', 'layers')
```

### Recap of what just happened

We have explored each component of `configure_toolbox.r`, which sets up for calculations by loading ohicore and other necessary R packages, and double check that your data layers are formatted and registered properly. 

![](https://docs.google.com/drawings/d/1oHMdrXNSeJ6l17aMUXihThYfb-HqvGviFrBYwJ2xldY/pub?h=450)

## Explore a goal model in `functions.r`

Remember from `calculate_scores.r` that after `configure_toolbox.r` runs, the next thing that happens is that `CalculateAll()` runs through the goal models and calculates Status and Trend. Status and Trend calculations are contained in `functions.r`.

![](https://docs.google.com/drawings/d/1VRckHItA151selmkBVtROk6OnLnI_ODIu2gIjSnFgmo/pub?h=450)

`functions.r` is contained in the `conf` folder:
![](https://docs.google.com/drawings/d/1CKNjIORLJOEaV2XW4Z9QuFLN7q1lJ1PaEGg2dSG1-_o/pub?h=450)

`functions.r` is a big list of all goal models in the assessment. Each goal model is an individual `R` function that calculates Status and Trend, and you will modify the goal model within the confines of each function. You can run all of them at the once or each individually.

Let's look at the goal models for Artisanal Fishing Opportunity (AO) as an example. It has models developed from the most recent global assessment as a place for you to start.

> **Tip**: Clicking the bottom left corner of Console will show you a drop-down menu of all functions. It's a shortcut to jump to the appropriate section or goal model

 > ![](https://docs.google.com/drawings/d/1Z2AVtVfIZEd_5GDcmaLb8mRpErKTDzmcbg0SBMxKsxs/pub?h=450)

The following things happen in each goal model:
  
  - load specific data layers (using `ohicore::SelectLayersData()`) 
  - calculate Status scores 
  - calculate Trend scores 
  - combine Status and Trend scores 
  - format and return the `scores` object


### Load specific data layers with `SelectLayersData()`

`SelectLayersData()` is an `ohicore` function to call the appropriate data layers by its layer name registered in `layers.csv` (e.g. "ao_access")
Run this chunk of code and the data layers will be loaded, joined, and ready to be manipulated further: 

```{r load_data, eval=FALSE}
 ## read in individual data layers
  d1 <- SelectLayersData(layers, layers = 'ao_access', narrow=TRUE) %>%
    select(region_id = id_num, access = val_num)

  d2 <- SelectLayersData(layers, layers = 'ao_need', narrow=TRUE) %>%
    select(region_id = id_num, year, need = val_num)

  ## join data layers into single data frame (see RStudio cheatsheets)
  ao_data <- left_join(d1, d2, by="region_id") 
```

> Tip: it's always a good idea to check what your data looks like and make sure there are no glaring errors. A couple of commonly used functions are: head() and str()

### Goal Model 

The goal model that was developed for global assessments and described in Halpern et al. 2012 Supplemental Information (p. 19) states that the status for this goal is therefore measured by unmet demand (Du), which includes measures of opportunity for artisanal fishing, and the sustainability of the methods used. 

$$
D_{U} = (1 - need) * (1 - access)
$$
$$
status = (1 - D_{U}) * sustainability
$$

```{r ao goal model, eval=FALSE}
 ao_model <- ao_data %>%
    mutate(Du = (1 - need) * (1 - access)) %>%
    mutate(status = (1 - Du) * sustainability)
  # head(ao_model); summary(ao_model)
```

### Calculate Status 

Once you make sure your data layer has been loaded and joined in the right format, you can start calculate status scores!

This syntax uses the `tidyverse` package that you loaded in `configure_toolbox.r`. It contains the commonly used data-wrangling functions you'll need in almost every analysis, and enables chaining: `%>%`. We'll briefly explain some of the functions below as we encounter them. 

To learn more, take a look at [tidyverse.org](http://tidyverse.org/). This [cheatsheet](https://www.rstudio.com/wp-content/uploads/2015/02/data-wrangling-cheatsheet.pdf) is also a helpful guide with quick references to each function. 

```{r, eval=FALSE}
# model: this step calculates status scores of all years, using the goal model. 

## "mutate" is another commonly used function from dplyr that allows you to add a new column to the data frame
## Note that "sustainability" and "status_year" have been defined at the start of the AO function 
  sustainability=1.0
  status_year = 2015

  ao_model <- ao_data %>%
    mutate(Du = (1 - (need+poverty/2)) * (1 - access)) %>%
    mutate(status = (1 - Du) * sustainability)
  
# status: status scores are typically the most recent year of all the years you have calculated. 
  ao_status <- ao_model %>%
    filter(year==status_year) %>%
    select(region_id, status) %>%
    mutate(status=status*100)
```

### Calculate Trend 

Trend scores are typically based on linear regression of status scores from the most recent five years. 

```{r, eval=FALSE}
 # choose trend years (eg. most recent five years)

  trend_years <- (status_year-4):(status_year)
  adj_trend_year <- min(trend_years)

  ao_trend = ao_model %>%
    group_by(region_id) %>% 
    # linear model: 
    do(mdl = lm(status ~ year, data=., subset=year %in% trend_years),
       adjust_trend = .$status[.$year == adj_trend_year]) %>%
    # extract the coefficient of year and produce a trend score
    summarize(region_id, trend = ifelse(coef(mdl)['year']==0, 0, coef(mdl)['year']/adjust_trend * 5)) %>%
    # make sure that the scores are between -1 and 1
    mutate(trend = ifelse(trend>1, 1, trend)) %>%
    mutate(trend = ifelse(trend<(-1), (-1), trend)) %>%
    mutate(trend = round(trend, 4))

```

### Scores variable: combining status and trend

Choose only the `region_id` and `score` columns, and add two more columns identifying score dimension (Status or Trend) and goal name. 
```{r, eval=FALSE}
 scores = ao_status %>%
    select(region_id, score=status) %>%
    mutate(dimension='status') %>%
    rbind(
      ao_trend %>%
        select(region_id, score=trend) %>%
        mutate(dimension='trend')) %>%
    mutate(goal='AO')
```

The scores variable is something that you'll see at the end of every goal model; `ohicore` will combine these all together when `CalculateAll()` runs.

### Recap of what just happened

`functions.r` is a collection of goal models to calculate status and trend. Each goal is written inside an R function. 


## Tailor a goal model using original data layers

![](https://docs.google.com/drawings/d/1VRckHItA151selmkBVtROk6OnLnI_ODIu2gIjSnFgmo/pub?h=450)

Modifying a goal model involves editing the operations within that goal's model in `functions.r`. 

First let's restart `R` and source `configure_toolbox.r`. We can do this from either `calculate_scores.r` or from `configure_toolbox.r` itself.

Now, let's go to `functions.r` and go back to the AO model. Let's do something pretty simple to tailor the goal model. Let's say we just wanted to divide the variable `Du` by 2 in the equation. 

```{r tailor AO goal model, eval=FALSE}
 ao_model <- ao_data %>%
    mutate(Du = (1 - need) * (1 - access)) %>%
    mutate(status = (1 - Du/2) * sustainability)
```

We can run the rest of the AO function line-by-line and inspect the scores variable at the end to see if everything looks OK. 

It looks OK to me, so let's run the rest of `calculate_scores.r`, and use Git's differencing feature to see how our scores have changed. This is a great way to double-check and error-check that things are working the way you expected. 


## Tailor a goal model using new data layers
 
The final thing we will do in this chapter is to tailor a goal model by adding a new variable. This will mean that we will prepare, save, and register a *new* data layer and update the goal model in `functions.r`. It will be a combination of what we've done previously in this chapter. 

![](https://docs.google.com/drawings/d/1h3QLjIJCtVgNYtzYY5lQkFWxDhYC8MrNDjzdTMY_qVY/pub?h=450)

Let's say we want to tailor the AO goal model by adding a new variable for *poverty* into the equation.

$$
D_{U} = (1 - (need + poverty) / 2) * (1 - access)
$$
$$
status = (1 - D_{U}) * sustainability
$$


### Prepare and save our new data layer

We will create the new data layer for poverty by running a script in the prep folder. 

Open `toolbox-demo/prep/AO/poverty_prep.R` and source the file after reading it through. The result will be a new data layer saved to the "layers" folder, and you should see that there is a new file saved in your Git window. 

### Register our new data layer 

Now that we have prepared and saved our data layer, we'll register it in `layers.csv`. This time, since we have added an additional data layer that has not been previously registered, we need to add a new row. 

Open `region2016/layers.csv` in a spreadsheet software (i.e. Microsoft Excel or Open Office). Add a new row for "ao_poverty", and fill in the following information. We've added the row near the other AO data layers.

![](figs/ao_poverty_demo_layers.png)

> Note: you could also script updating layers.csv from your prep file (not illustrated).

<!---TODO: script this from the prep file --->

### Update the AO goal model

We will need to do two things to update the goal model in `functions.r`.

First, we'll have to load our data layer with `SelectLayersData()`. You can copy-paste the following into your `functions.r` AO goal model and then run it after running `status_year=2015; sustainability=1.0` to make sure everything is working properly:

```{r SelectLayersData pov, eval=FALSE}
 ## read in individual data layers
  d1 <- SelectLayersData(layers, layers = 'ao_access', narrow=TRUE) %>%
    select(region_id = id_num, access = val_num)

  d2 <- SelectLayersData(layers, layers = 'ao_need', narrow=TRUE) %>%
    select(region_id = id_num, year, need = val_num)

  ## add new poverty data layer
  d3 <- SelectLayersData(layers, layers = 'ao_poverty', narrow=TRUE) %>%
    select(region_id = id_num, year, poverty = val_num)

  ## join data layers into single data frame, including the new poverty data layer
  ao_data <- left_join(d1, d2, by="region_id") %>%
    left_join(d3, by=c("region_id", "year"))
```

Next, we'll tailor the goal model itself. Here is how the goal model looks as an equation and in `R`: you can copy-paste this model into `functions.r`, replacing the existing model.

$$
D_{U} = (1 - (need + poverty) / 2) * (1 - access)
$$

$$
status = (1 - D_{U}) * sustainability
$$

```{r tailored ao goal model, eval=FALSE}
## tailored goal model with poverty
ao_model <- ao_data %>%
    mutate(Du = (1 - (need + poverty) / 2 ) * (1 - access)) %>%
    mutate(status = (1 - Du) * sustainability)
```

### Rerun `calculate_scores.r`

Everything is looking good in `functions.r` and in the Git tab that we're looking at as we go along. Now let's restart R and rerun `calculate_scores.r`. We'll see that `scores.csv` will also update when we run this. 

## Recap of this tutorial 

We have completed Chapter \@ref(calcs-basic)  successfully run through the basic workflow to calculate OHI scores with several variations using our **toolbox-demo** repository. 

Each variation involves the same basic workflow of bookkeeping and running `calculate_scores.r`, and will enable you to begin tailoring the Toolbox for your assessment.

![](https://docs.google.com/drawings/d/1OhA7p5-dmrk6dGeP_gWEXFD2pI1ik8KhUYNUSLUVgd4/pub?w=960&h=720)


<!---next steps after Eva training: 

## Update pressures and resilience matrices

- PlotFlower, PlotMap
- updating pressures/resilience matrices


--->
